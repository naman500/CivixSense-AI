<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivixSense AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            position: relative;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
            width: 100%;
        }
        
        /* Watermark container */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            right: 0;  
            bottom: 0;
            left: 0;
            background-image: url('/static/images/Main_logo.jpg');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 50%;  /* Increased from 50% to 60% */
            opacity: 0.2;  /* Increased from 0.3 to 0.4 */
            pointer-events: none;
            z-index: 0;  /* Changed from -1 to 0 */
        }

        /* Make cards and content slightly transparent to show watermark */
        .camera-card, .card {
            background-color: rgba(255, 255, 255, 0.9) !important;  /* Made more transparent */
            position: relative;
            z-index: 1;  /* Ensure cards are above watermark */
        }

        /* Ensure text remains readable */
        .camera-info {
            background-color: rgba(255, 255, 255, 0.95) !important;
        }

        /* Keep sidebar solid */
        .sidebar {
            position: relative;
            z-index: 1;
        }
        
        .dashboard-title {
            color: #0d6efd;
            font-weight: 700;
        }
        .camera-card {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .camera-card:hover {
            transform: translateY(-5px);
        }
        .camera-feed {
            width: 100%;
            height: auto;
            background-color: #000;
        }
        .camera-info {
            padding: 15px;
            background-color: #fff;
        }
        .crowd-count {
            font-size: 24px;
            font-weight: bold;
        }
        .normal {
            color: #28a745;
        }
        .warning {
            color: #ffc107;
        }
        .danger {
            color: #dc3545;
        }
        .alert-card {
            border-left: 4px solid #dc3545;
            background-color: #fff;
            margin-bottom: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .chart-container {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 249, 250, 0.95));
            border-radius: 20px;
            padding: 25px;
            box-shadow: 20px 20px 60px rgba(0, 0, 0, 0.05),
                        -20px -20px 60px rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
            width: 100%;
            overflow-x: hidden;
        }

        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, transparent 45%, var(--accent-color, rgba(13, 110, 253, 0.1)) 100%);
            border-radius: 0 20px 0 100%;
            transition: all 0.3s ease;
        }

        .chart-container::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(315deg, transparent 45%, var(--accent-color, rgba(13, 110, 253, 0.1)) 100%);
            border-radius: 0 100% 0 20px;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 25px 25px 70px rgba(0, 0, 0, 0.07),
                        -25px -25px 70px rgba(255, 255, 255, 0.9);
        }

        /* Dynamic color states for charts */
        .chart-container.normal {
            --accent-color: rgba(40, 167, 69, 0.2);
            border-left: 4px solid #28a745;
        }

        .chart-container.warning {
            --accent-color: rgba(255, 193, 7, 0.2);
            border-left: 4px solid #ffc107;
        }

        .chart-container.danger {
            --accent-color: rgba(220, 53, 69, 0.2);
            border-left: 4px solid #dc3545;
        }

        .chart-value {
            font-size: 2rem;
            font-weight: 600;
            text-align: right;
            position: absolute;
            top: 25px;
            right: 25px;
            z-index: 1;
            transition: all 0.3s ease;
        }

        .chart-value.normal { color: #28a745; }
        .chart-value.warning { color: #ffc107; }
        .chart-value.danger { color: #dc3545; }

        .chart-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-title::before {
            content: '';
            display: block;
            width: 4px;
            height: 24px;
            background: var(--accent-color, #0d6efd);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .chart-subtitle {
            font-size: 1rem;
            color: #6c757d;
            margin-bottom: 25px;
            padding-left: 14px;
            border-left: 2px solid var(--accent-color, rgba(13, 110, 253, 0.2));
            transition: all 0.3s ease;
        }

        /* Chart grid layout */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            padding: 30px 0;
        }

        .chart-wrapper {
            position: relative;
            padding: 20px 10px;
            height: 350px;  /* Increased height */
        }

        /* Chart legend styles */
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            backdrop-filter: blur(5px);
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            color: #495057;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }

        .legend-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .legend-color {
            width: 14px;
            height: 14px;
            border-radius: 4px;
            margin-right: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Custom styles for each chart type */
        .chart-container.crowd-trends {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(237, 242, 255, 0.95));
        }

        .chart-container.fps {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(237, 255, 240, 0.95));
        }

        .chart-container.latency {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(255, 249, 237, 0.95));
        }

        .sidebar {
            background: linear-gradient(180deg, #1a237e 0%, #283593 100%);
            min-height: 100vh;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar h5 {
            color: white;
            font-weight: 600;
        }
        .sidebar-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }
        .sidebar-link:hover, .sidebar-link.active {
            color: white;
            background: rgba(255,255,255,0.1);
        }
        .sidebar-link i {
            margin-right: 10px;
        }
        .modal-header {
            background-color: #0d6efd;
            color: white;
        }
        .camera-offline {
            opacity: 0.7;
            filter: grayscale(100%);
        }
        .offline-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 100;
        }
        .text-danger {
            color: #dc3545 !important;
        }
        
        .flash-text {
            animation: flash 1s ease-out infinite alternate;
        }
        
        @keyframes flash {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .camera-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }
        .camera-actions {
            margin-top: 10px;
        }
        .chart-container {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .stat-card {
            background-color: white;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            text-align: center;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        .crowd-count {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }
        .normal {
            background-color: #28a745;
            color: white;
        }
        .warning {
            background-color: #ffc107;
            color: black;
        }
        .danger {
            background-color: #dc3545;
            color: white;
        }
        .dashboard-header {
            margin-bottom: 30px;
        }
        #roi-canvas {
            border: 1px solid #dee2e6;
            width: 100%;
            height: auto;
        }
        .alert-item {
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        .alert-item:hover {
            background-color: #f8f9fa;
        }
        .alert-item:last-child {
            border-bottom: none;
        }
        .alert-list {
            max-height: 300px;
            overflow-y: auto;
        }
        /* ROI Canvas Styles */
        .canvas-container {
            position: relative;
            width: 100%;
            min-height: 480px;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            background-color: #f8f9fa;
        }
        
        #roi-canvas {
            max-width: 100%;
            height: auto;
            min-height: 480px;
            display: block;
            margin: 0 auto;
            background-color: #f0f0f0;
            border: 2px solid #ccc;
            border-radius: 4px;
            cursor: crosshair;
            image-rendering: -webkit-optimize-contrast; /* Sharper image rendering */
            image-rendering: crisp-edges;
        }
        
        #canvas-loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        
        /* Make modal larger for better viewing */
        #roiModal .modal-dialog {
            max-width: 90%;
        }
        
        /* Fix for canvas scaling */
        @media (max-width: 768px) {
            #roi-canvas {
                min-height: 320px;
            }
            
            .canvas-container {
                min-height: 320px;
            }
        }

        .performance-metrics {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .fps-info {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 8px;
        }

        .target-fps {
            color: #28a745;
            font-weight: bold;
        }

        .actual-fps {
            color: #007bff;
            font-weight: bold;
        }

        .latency-value {
            color: #dc3545;
            font-weight: bold;
        }
        .logo-image {
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        .logo-image:hover {
            transform: scale(1.05);
        }

        /* Add enhanced chart styles */
        /* Chart container styles */
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
        }

        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
        }

        .chart-subtitle {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 20px;
        }

        /* Chart grid layout */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            padding: 20px 0;
        }

        .chart-wrapper {
            position: relative;
            padding-top: 10px;
        }

        /* Chart legend styles */
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            margin-right: 8px;
        }

        /* Resource Monitor Styles */
        .resource-card {
            background: linear-gradient(145deg, #ffffff, #f5f7fa);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.05),
                       -5px -5px 15px rgba(255, 255, 255, 0.6);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .resource-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, transparent 45%, rgba(var(--accent-color), 0.1) 100%);
            border-radius: 0 20px 0 100%;
        }

        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.08),
                       -8px -8px 20px rgba(255, 255, 255, 0.8);
        }

        .resource-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            background: linear-gradient(45deg, var(--icon-color-1), var(--icon-color-2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            opacity: 0.9;
        }

        .resource-info h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .resource-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 15px 0;
            color: var(--value-color);
            display: flex;
            align-items: baseline;
            gap: 5px;
        }

        .resource-value small {
            font-size: 1rem;
            opacity: 0.7;
        }

        .resource-progress {
            height: 8px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            transition: width 0.5s ease, background-color 0.3s ease;
        }

        /* CPU Card Theme */
        .resource-card.cpu {
            --accent-color: 52, 152, 219;
            --icon-color-1: #3498db;
            --icon-color-2: #2980b9;
            --value-color: #2980b9;
        }

        .cpu-bar {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        /* RAM Card Theme */
        .resource-card.ram {
            --accent-color: 46, 204, 113;
            --icon-color-1: #2ecc71;
            --icon-color-2: #27ae60;
            --value-color: #27ae60;
        }

        .ram-bar {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
        }

        /* Disk Card Theme */
        .resource-card.disk {
            --accent-color: 155, 89, 182;
            --icon-color-1: #9b59b6;
            --icon-color-2: #8e44ad;
            --value-color: #8e44ad;
        }

        .disk-bar {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
        }

        /* GPU Card Theme */
        .resource-card.gpu {
            --accent-color: 230, 126, 34;
            --icon-color-1: #e67e22;
            --icon-color-2: #d35400;
            --value-color: #d35400;
        }

        .gpu-bar {
            background: linear-gradient(90deg, #e67e22, #d35400);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .resource-card {
                margin-bottom: 20px;
            }
            
            .resource-value {
                font-size: 1.75rem;
            }
        }

        /* Alert Management Styles */
        .alerts-header {
            position: relative;
            padding: 20px;
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .alert-pulse {
            width: 12px;
            height: 12px;
            background-color: #dc3545;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);
            }
        }

        .alert-summary-card {
            background: linear-gradient(135deg, #dc3545, #c82333);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.15);
            transition: all 0.3s ease;
        }

        .alert-summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(220, 53, 69, 0.2);
        }

        .alert-summary-header {
            padding: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
        }

        .alert-summary-body {
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            color: white;
        }

        .alerts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }

        .camera-alert-card {
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .camera-alert-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }

        .camera-alert-header {
            padding: 15px 20px;
            background: var(--header-bg, #0d6efd);
            color: white;
        }

        .alert-item {
            padding: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .alert-item:hover {
            background-color: rgba(0, 0, 0, 0.02);
            transform: translateX(5px);
        }

        .alert-severity {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .alert-severity.high {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }

        .alert-severity.medium {
            background-color: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .alert-severity.low {
            background-color: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .alert-timestamp {
            font-size: 0.85rem;
            color: rgba(0, 0, 0, 0.5);
        }

        .alert-details {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .alert-action-list {
            list-style: none;
            padding: 0;
            margin: 10px 0 0;
        }

        .alert-action-list li {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            color: rgba(0, 0, 0, 0.7);
        }

        .alert-action-list li::before {
            content: '•';
            color: var(--bs-primary);
        }

        /* Alert Animation */
        @keyframes alertIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .new-alert {
            animation: alertIn 0.3s ease-out forwards;
        }

        /* Alert Count Badge Animation */
        @keyframes countUpdate {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .count-update {
            animation: countUpdate 0.3s ease-out;
        }

        /* Sidebar Styles */
        .sidebar {
            background: linear-gradient(135deg, #2c003e, #551155);
            min-height: 100vh;
            padding: 1.5rem;
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* Creative Background Pattern with new colors */
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 20%, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 50%),
                linear-gradient(45deg, transparent 48%, rgba(255, 255, 255, 0.05) 49%, rgba(255, 255, 255, 0.05) 51%, transparent 52%),
                linear-gradient(-45deg, transparent 48%, rgba(255, 255, 255, 0.05) 49%, rgba(255, 255, 255, 0.05) 51%, transparent 52%);
            background-size: 100% 100%, 100% 100%, 20px 20px, 20px 20px;
            opacity: 0.8;
            z-index: -1;
        }

        /* Enlarged Logo Section */
        .sidebar-logo {
            padding: 2.5rem 0 3.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
            position: relative;
        }

        .sidebar-logo::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 15%;
            width: 70%;
            height: 2px;
            background: linear-gradient(to right, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                rgba(255, 255, 255, 0.5), 
                rgba(255, 255, 255, 0.3), 
                transparent
            );
        }

        .sidebar-logo img {
            width: 200px;  /* Increased from 180px */
            height: 200px; /* Increased from 180px */
            border-radius: 30px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
            box-shadow: 
                0 12px 24px rgba(0, 0, 0, 0.3),
                0 -2px 8px rgba(255, 255, 255, 0.2);
            margin: 0.5rem auto 1.5rem;
        }

        .sidebar-logo img:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 
                0 15px 30px rgba(0, 0, 0, 0.25),
                0 -2px 10px rgba(255, 255, 255, 0.2);
        }

        .sidebar-logo h2 {
            color: white;
            font-size: 2.2rem;
            margin: 2rem 0 0;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to right, #fff, #e0e0e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }

        .sidebar-logo h2::after {
            content: 'AI Powered Monitoring';
            position: absolute;
            bottom: -1.5rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1rem;
            font-weight: normal;
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
            text-shadow: none;
            -webkit-text-fill-color: rgba(255, 255, 255, 0.8);
        }

        /* Enhanced Navigation Links with new color scheme */
        .nav-link {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 1rem 1.2rem;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.2),
                0 -2px 4px rgba(255, 255, 255, 0.1);
        }

        /* Enhanced Bottom Section with new gradient */
        .sidebar-bottom {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 1.5rem;
            background: linear-gradient(to top, 
                rgba(44, 0, 62, 0.95), 
                rgba(85, 17, 85, 0.7),
                transparent
            );
            backdrop-filter: blur(5px);
        }

        /* Logo Section */
        .sidebar-logo {
            padding: 1rem 0 2rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
        }

        .sidebar-logo img {
            width: 80px;
            height: 80px;
            border-radius: 15px;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            transition: transform 0.3s ease;
        }

        .sidebar-logo img:hover {
            transform: scale(1.05);
        }

        .sidebar-logo h2 {
            color: white;
            font-size: 1.5rem;
            margin: 1rem 0 0;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* Navigation Links */
        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            padding: 0.8rem 1.2rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-link:before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 0;
            background: rgba(255, 255, 255, 0.1);
            transition: width 0.3s ease;
        }

        .nav-link:hover:before {
            width: 100%;
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            color: white !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .nav-link i {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .nav-link:hover i {
            transform: translateX(5px);
        }

        /* Alert Badge */
        .nav-link .badge {
            position: absolute;
            right: 1rem;
            padding: 0.35rem 0.65rem;
            border-radius: 20px;
            background: #dc3545;
            color: white;
            font-size: 0.75rem;
            transition: all 0.3s ease;
        }

        .nav-link:hover .badge {
            transform: scale(1.1);
        }

        /* Bottom Section */
        .sidebar-bottom {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 1.5rem;
            background: linear-gradient(to top, rgba(26, 35, 126, 0.95), transparent);
        }

        /* Decorative Elements */
        .sidebar:after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            width: 1px;
            background: linear-gradient(to bottom, 
                rgba(255, 255, 255, 0.1),
                rgba(255, 255, 255, 0.05),
                transparent);
        }

        .nav-link .nav-indicator {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 0;
            background: #fff;
            border-radius: 0 2px 2px 0;
            transition: height 0.3s ease;
        }

        .nav-link:hover .nav-indicator {
            height: 60%;
        }

        .nav-link.active .nav-indicator {
            height: 80%;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.show {
                transform: translateX(0);
            }
        }

        /* Main Content Styles */
        .main-content {
            margin-left: 280px;
            padding: 2rem;
            min-height: 100vh;
            background: #f8f9fa;
            transition: all 0.3s ease;
            width: calc(100% - 280px);
        }

        /* Mobile Responsive Adjustments */
        @media (max-width: 992px) {
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 1rem;
            }

            .container-fluid {
                padding-right: 10px;
                padding-left: 10px;
            }
        }

        /* Add mobile toggle button */
        @media (min-width: 993px) {
            .sidebar-toggle {
                display: none;
            }
        }

        /* Restore sidebar toggle button */
        @media (max-width: 992px) {
            .sidebar-toggle {
                display: block;
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 1001;
                background: white;
                border: none;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }

            .sidebar-toggle:hover {
                transform: scale(1.1);
            }

            .sidebar-toggle i {
                font-size: 1.2rem;
                color: #1a237e;
            }
        }

        /* Additional container fixes */
        .col, .col-1, .col-2, .col-3, .col-4, .col-5, .col-6, 
        .col-7, .col-8, .col-9, .col-10, .col-11, .col-12, 
        .col-md-1, .col-md-2, .col-md-3, .col-md-4, .col-md-5, .col-md-6, 
        .col-md-7, .col-md-8, .col-md-9, .col-md-10, .col-md-11, .col-md-12 {
            padding-right: 10px;
            padding-left: 10px;
        }

        /* Table container fixes */
        .table-responsive {
            overflow-x: hidden;
        }

        /* Card fixes */
        .card {
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }

        /* Alert container fixes */
        .alerts-grid {
            width: 100%;
            margin: 0;
            padding: 0 5px;
            box-sizing: border-box;
        }

        /* Chart container adjustments */
        .chart-wrapper {
            width: 100%;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
        }

        /* Analytics section fixes */
        #analytics-section .row {
            margin: 0;
            width: 100%;
        }

        /* Settings section fixes */
        #settings-section .row {
            margin: 0;
            width: 100%;
        }

        /* Alert Sound Control Styles */
        .alert-sound-control {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 8px 15px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .alert-sound-control:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .alert-sound-toggle {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1a237e;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .alert-sound-toggle i {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .alert-sound-toggle:hover i {
            transform: scale(1.1);
        }

        .alert-sound-toggle.active {
            color: #4CAF50;
        }

        .alert-sound-toggle.inactive {
            color: #dc3545;
        }

        .alert-sound-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .alert-sound-status.active {
            background-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .alert-sound-status.inactive {
            background-color: #dc3545;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }

        @media (max-width: 768px) {
            .alert-sound-control {
                top: auto;
                bottom: 20px;
                right: 20px;
            }
        }

        /* Remove the old Alert Sound button styles */
        .alert-sound-btn {
            display: none;
        }

        /* Remove Alert Sound Control Styles */
        .alert-sound-control,
        .alert-sound-toggle,
        .alert-sound-status {
            display: none !important;
        }

        /* Additional texture overlay for sidebar */
        .sidebar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(45deg, 
                    rgba(255, 255, 255, 0.03) 0px,
                    rgba(255, 255, 255, 0.03) 1px,
                    transparent 1px,
                    transparent 10px
                ),
                repeating-linear-gradient(-45deg,
                    rgba(255, 255, 255, 0.02) 0px,
                    rgba(255, 255, 255, 0.02) 1px,
                    transparent 1px,
                    transparent 15px
                );
            opacity: 0.5;
            z-index: -1;
            pointer-events: none;
        }

        /* Add smooth scrolling to main content */
        .main-content {
            scroll-behavior: smooth;
        }

        /* Add padding to sections for better scrolling */
        .section {
            padding-top: 2rem;
            scroll-margin-top: 2rem;
        }

        /* Enhanced Logo and Header Styles */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(249,250,251,0.9) 100%);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(31,38,135,0.15);
            backdrop-filter: blur(4px);
            margin-bottom: 2rem;
            border: 1px solid rgba(255,255,255,0.18);
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-text {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(45deg, #2c003e, #551155);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            letter-spacing: -0.5px;
            position: relative;
        }

        .logo-text::after {
            content: 'AI';
            position: relative;
            margin-left: 8px;
            font-size: 1.8rem;
            background: linear-gradient(45deg, #ff3366, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
        }

        .header-buttons {
            display: flex;
            gap: 1rem;
        }

        .btn-reset-cameras {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #ff3366 0%, #ff6b6b 100%);
            border: none;
            color: white;
            box-shadow: 0 4px 15px rgba(255,51,102,0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-reset-cameras:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255,51,102,0.3);
        }

        .btn-add-camera {
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border: none;
            color: white;
            box-shadow: 0 4px 15px rgba(52,152,219,0.2);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-add-camera:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52,152,219,0.3);
        }

        .btn-icon {
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .header-buttons {
                width: 100%;
                justify-content: center;
            }
            
            .logo-text {
                font-size: 2rem;
            }
        }

        /* Enhanced Modal Styles */
        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: none;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .modal-header {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            border: none;
            padding: 1.5rem;
        }

        .modal-title {
            color: white;
            font-weight: 600;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-title i {
            font-size: 1.4rem;
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-control {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.9);
        }

        .form-control:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52,152,219,0.15);
            background: white;
        }

        .form-text {
            color: #6c757d;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .form-select {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            background-position: right 1rem center;
        }

        .form-select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 0.2rem rgba(52,152,219,0.15);
        }

        .btn-test-connection {
            background: linear-gradient(135deg, #00b894 0%, #00a884 100%);
            border: none;
            border-radius: 10px;
            padding: 0.6rem 1.2rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .btn-test-connection:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,184,148,0.2);
        }

        .modal-footer {
            border-top: 1px solid rgba(0,0,0,0.05);
            padding: 1.5rem;
            background: rgba(248,249,250,0.5);
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }

        .btn-modal-cancel {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            color: #495057;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-modal-cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn-modal-add {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-modal-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52,152,219,0.2);
        }

        /* Input group enhancements */
        .input-group-text {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 0.75rem 1rem;
        }
    </style>
</head>
<body>
    <!-- Audio controls -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="alert-sound-toggle" checked>
            <label class="form-check-label" for="alert-sound-toggle">Alert Sound</label>
        </div>
    </div>
    
    <!-- Single Audio element for alert sound (global) -->
    <audio id="alert-sound" preload="auto">
        <source src="/static/audio/Overcrowd_Detected__.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    
    <div class="container-fluid">
        <!-- Add audio element for alerts -->
        
        
        <div class="row">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="sidebar-logo">
                    <img src="/static/images/Main_logo.jpg" alt="CivixSense AI">
                    <h2>CivixSense AI</h2>
                </div>

                <nav class="nav flex-column">
                    <div class="nav-item">
                        <a href="#cameras-section" class="nav-link active">
                            <span class="nav-indicator"></span>
                            <i class="bi bi-camera-video"></i>
                            <span>Cameras</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#alerts-section" class="nav-link">
                            <span class="nav-indicator"></span>
                            <i class="bi bi-exclamation-triangle"></i>
                            <span>Alerts</span>
                            <span class="badge" id="sidebar-alert-badge">0</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#analytics-section" class="nav-link">
                            <span class="nav-indicator"></span>
                            <i class="bi bi-graph-up"></i>
                            <span>Analytics</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#resource-monitor-section" class="nav-link">
                            <span class="nav-indicator"></span>
                            <i class="bi bi-speedometer2"></i>
                            <span>System Resource Monitor</span>
                        </a>
                    </div>
                </nav>

                <div class="sidebar-bottom">
                    <div class="d-flex align-items-center gap-2 text-white-50">
                        <i class="bi bi-circle-fill text-success"></i>
                        <small>System Status: Online</small>
                    </div>
                </div>
            </div>
            
            <!-- Main Content -->
            <div class="main-content">
                <!-- Enhanced Header Section -->
                <div class="dashboard-header">
                    <div class="logo-section">
                        <h1 class="logo-text">CivixSense</h1>
                    </div>
                    <div class="header-buttons">
                        <button id="reset-cameras-btn" class="btn-reset-cameras">
                            <i class="bi bi-arrow-counterclockwise btn-icon"></i>
                            Reset All Cameras
                        </button>
                        <button id="add-camera-btn" class="btn-add-camera" data-bs-toggle="modal" data-bs-target="#addCameraModal">
                            <i class="bi bi-plus-lg btn-icon"></i>
                            Add Camera
                        </button>
                    </div>
                </div>
                
                <!-- Camera Section -->
                <section id="camera-section" class="section">
                    <h3 class="mb-3">Live Cameras</h3>
                    <div class="row" id="camera-feed-container">
                        <!-- Camera cards will be added here dynamically -->
                    </div>
                </section>
                
                <!-- Alerts Section -->
                <section id="alerts-section" class="section">
                    <div class="alerts-header d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center gap-3">
                        <h3 class="mb-0">Alert Management</h3>
                            <div class="alert-pulse"></div>
                            <div class="badge bg-danger px-3 py-2" id="total-alerts-count">0</div>
                        </div>
                        <button id="reset-alerts-btn" class="btn btn-outline-danger d-flex align-items-center gap-2">
                            <i class="bi bi-trash3"></i>
                            <span>Clear History</span>
                        </button>
                    </div>
                    
                    <!-- Summary Alert Card -->
                    <div class="alert-summary-card mb-4">
                        <div class="alert-summary-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0 d-flex align-items-center gap-2">
                                    <i class="bi bi-shield-exclamation"></i>
                                    Summary - All Cameras
                                </h5>
                                <div class="alert-actions">
                                    <button class="btn btn-sm btn-outline-light" onclick="expandAllAlerts()">
                                        <i class="bi bi-arrows-angle-expand"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-light" onclick="collapseAllAlerts()">
                                        <i class="bi bi-arrows-angle-contract"></i>
                                    </button>
                        </div>
                            </div>
                        </div>
                        <div class="alert-summary-body" id="alerts-summary">
                            <div class="alert alert-info bg-white bg-opacity-25 border-0">No active alerts.</div>
                        </div>
                    </div>
                    
                    <!-- Per-Camera Alert Cards -->
                    <div id="alerts-by-camera" class="row alerts-grid">
                        <!-- Camera-specific alert cards will be added here dynamically -->
                    </div>
                </section>
                
                <!-- Analytics Section -->
                <section id="analytics-section" class="section">
                    <h3 class="mb-4">Analytics Dashboard</h3>
                    <div class="charts-grid">
                        <!-- Crowd Trends Chart -->
                        <div id="crowdTrends-container" class="chart-container normal">
                            <div class="chart-value normal">0</div>
                            <h4 class="chart-title">
                                Crowd Trends
                            </h4>
                            <p class="chart-subtitle">Real-time monitoring of crowd density patterns</p>
                            <div class="chart-wrapper">
                                <canvas id="crowdTrendsChart"></canvas>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: var(--accent-color, #0d6efd);"></div>
                                    <span>Crowd Count</span>
                        </div>
                            </div>
                        </div>

                        <!-- FPS Chart -->
                        <div id="fps-container" class="chart-container normal">
                            <div class="chart-value normal">0</div>
                            <h4 class="chart-title">
                                Performance (FPS)
                            </h4>
                            <p class="chart-subtitle">Real-time frame processing speed analysis</p>
                            <div class="chart-wrapper">
                                <canvas id="fpsChart"></canvas>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: var(--accent-color, #28a745);"></div>
                                    <span>Frames Per Second</span>
                        </div>
                    </div>
                        </div>

                        <!-- Latency Chart -->
                        <div id="latency-container" class="chart-container normal">
                            <div class="chart-value normal">0</div>
                            <h4 class="chart-title">
                                Processing Latency
                            </h4>
                            <p class="chart-subtitle">System response time and processing efficiency</p>
                            <div class="chart-wrapper">
                                <canvas id="latencyChart"></canvas>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background: var(--accent-color, #ffc107);"></div>
                                    <span>Response Time (ms)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <!-- Resource Monitor Section -->
                <section id="resource-monitor-section" class="section">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3 class="mb-0">System Resource Monitor</h3>
                        <div class="badge bg-primary bg-opacity-10 text-primary px-3 py-2">
                            <i class="bi bi-clock"></i> Real-time Monitoring
                        </div>
                    </div>
                    <div class="row g-4">
                        <!-- CPU Usage Card -->
                        <div class="col-md-3">
                            <div class="resource-card cpu">
                                <div class="resource-icon">
                                    <i class="bi bi-cpu"></i>
                            </div>
                                <div class="resource-info">
                                    <h4>CPU Usage</h4>
                                    <div class="resource-value">
                                        <span id="cpu-usage">--</span>
                                        <small>%</small>
                        </div>
                                    <div class="progress resource-progress">
                                        <div class="progress-bar cpu-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- RAM Usage Card -->
                        <div class="col-md-3">
                            <div class="resource-card ram">
                                <div class="resource-icon">
                                    <i class="bi bi-memory"></i>
                            </div>
                                <div class="resource-info">
                                    <h4>RAM Usage</h4>
                                    <div class="resource-value">
                                        <span id="ram-usage">--</span>
                                        <small>%</small>
                        </div>
                                    <div class="progress resource-progress">
                                        <div class="progress-bar ram-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Disk Usage Card -->
                        <div class="col-md-3">
                            <div class="resource-card disk">
                                <div class="resource-icon">
                                    <i class="bi bi-hdd"></i>
                            </div>
                                <div class="resource-info">
                                    <h4>Disk Usage</h4>
                                    <div class="resource-value">
                                        <span id="disk-usage">--</span>
                                        <small>%</small>
                        </div>
                                    <div class="progress resource-progress">
                                        <div class="progress-bar disk-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- GPU Usage Card -->
                        <div class="col-md-3">
                            <div class="resource-card gpu">
                                <div class="resource-icon">
                                    <i class="bi bi-gpu-card"></i>
                            </div>
                                <div class="resource-info">
                                    <h4>GPU Usage</h4>
                                    <div class="resource-value">
                                        <span id="gpu-usage">--</span>
                                        <small>%</small>
                                    </div>
                                    <div class="progress resource-progress">
                                        <div class="progress-bar gpu-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>
    
    <!-- Enhanced Add Camera Modal -->
    <div class="modal fade" id="addCameraModal" tabindex="-1" aria-labelledby="addCameraModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addCameraModalLabel">
                        <i class="bi bi-camera-fill"></i>
                        Add New Camera
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="add-camera-form">
                        <div class="form-group">
                            <label for="camera-id" class="form-label">Camera ID</label>
                            <input type="text" class="form-control" id="camera-id" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="camera-name" class="form-label">Camera Name</label>
                            <input type="text" class="form-control" id="camera-name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="camera-url" class="form-label">Camera URL/IP</label>
                            <input type="text" class="form-control" id="camera-url" required>
                            <div class="form-text">Examples: http://192.168.1.100:8080/video or simply 0 for local webcam</div>
                            <button type="button" class="btn-test-connection" id="test-camera-btn">
                                <i class="bi bi-broadcast"></i>
                                Test Connection
                            </button>
                        </div>
                        
                        <div class="form-group">
                            <label for="camera-threshold" class="form-label">Crowd Threshold</label>
                            <input type="number" class="form-control" id="camera-threshold" value="50" required>
                            <div class="form-text">Alert when crowd count exceeds this number</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="density-threshold" class="form-label">Density Threshold</label>
                            <input type="number" class="form-control" id="density-threshold" value="20" required>
                            <div class="form-text">Switch to hybrid mode when crowd count exceeds this number</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="camera-priority" class="form-label">Camera Priority</label>
                            <select class="form-select" id="camera-priority" required>
                                <option value="1">1 - Lowest</option>
                                <option value="2">2 - Low</option>
                                <option value="3" selected>3 - Medium</option>
                                <option value="4">4 - High</option>
                                <option value="5">5 - Highest</option>
                                <option value="6">6 - Critical</option>
                            </select>
                            <div class="form-text">Higher priority cameras receive more processing resources</div>
                        </div>
                        
                        <div class="form-group mb-0">
                            <label for="camera-fps" class="form-label">Frames Per Second (FPS)</label>
                            <select class="form-select" id="camera-fps" required>
                                <option value="30" selected>30 FPS - Standard</option>
                                <option value="15">15 FPS - Low</option>
                                <option value="60">60 FPS - High</option>
                            </select>
                            <div class="form-text">Target frame rate for this camera</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn-modal-add" id="save-camera-btn">Add Camera</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Test Camera Modal -->
    <div class="modal fade" id="testCameraModal" tabindex="-1" aria-labelledby="testCameraModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="testCameraModalLabel">Camera Connection Test</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div class="spinner-border text-primary" role="status" id="camera-test-spinner">
                            <span class="visually-hidden">Testing...</span>
                        </div>
                        <p id="camera-test-status">Testing camera connection...</p>
                    </div>
                    <div id="camera-test-results" class="d-none">
                        <h6>Test Results:</h6>
                        <div class="alert alert-info" id="camera-best-url"></div>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>URL Format</th>
                                    <th>Connection</th>
                                    <th>Frame Read</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="camera-test-table">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ROI Selection Modal -->
    <div class="modal fade" id="roiModal" tabindex="-1" aria-labelledby="roiModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="roiModalLabel">Region of Interest Selection</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="canvas-container">
                                <div id="canvas-loading-indicator" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">Loading camera feed...</p>
                                </div>
                                <canvas id="roi-canvas"></canvas>
                        </div>
                                    </div>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-header">ROI Statistics</div>
                                <div class="card-body">
                                    <div id="roi-stats">
                                        <p class="mb-1">Points: <span id="roi-points-count">0</span></p>
                                        <p class="mb-1">Area: <span id="roi-area-percent">0%</span> of frame</p>
                                        <p class="mb-0">Status: <span id="roi-status" class="badge bg-secondary">No ROI</span></p>
                                </div>
                            </div>
                        </div>
                            <div class="card mb-3">
                                <div class="card-header">ROI Points</div>
                                <div class="card-body">
                            <div id="roi-points-list" class="mb-3">
                                        <!-- Points will be listed here -->
                            </div>
                                    <button type="button" class="btn btn-danger btn-sm" id="clear-roi-btn">
                                        <i class="bi bi-trash"></i> Clear Points
                    </button>
                            </div>
                        </div>
                            <div class="card">
                                <div class="card-header">ROI Management</div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-success btn-sm" id="save-roi-btn">
                        <i class="bi bi-check-lg"></i> Save ROI
                    </button>
                                        <button type="button" class="btn btn-primary btn-sm" id="save-roi-as-btn">
                                            <i class="bi bi-save"></i> Save ROI As Template
                                        </button>
                                        <button type="button" class="btn btn-info btn-sm" id="load-roi-template-btn">
                                            <i class="bi bi-folder"></i> Load ROI Template
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm" id="full-frame-roi-btn">
                                            <i class="bi bi-arrows-angle-expand"></i> Use Full Frame
                    </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="apply-roi-btn">Apply ROI</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Threshold Modal -->
    <div class="modal fade" id="thresholdModal" tabindex="-1" aria-labelledby="thresholdModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="thresholdModalLabel">Camera Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="threshold-form">
                        <input type="hidden" id="threshold-camera-id" name="camera-id">
                        <div class="mb-3">
                            <label for="alert-threshold" class="form-label">Alert Threshold</label>
                            <input type="number" class="form-control" id="alert-threshold" name="alert-threshold" min="1" value="50">
                            <div class="form-text">Maximum number of people before triggering an alert</div>
                        </div>
                        <div class="mb-3">
                            <label for="threshold-density" class="form-label">Density Threshold</label>
                            <input type="number" class="form-control" id="threshold-density" name="threshold-density" min="1" value="20">
                            <div class="form-text">Crowd density threshold for switching to density-based detection</div>
                        </div>
                        <div class="mb-3">
                            <label for="camera-priority" class="form-label">Camera Priority</label>
                            <select class="form-control" id="camera-priority" name="camera-priority">
                                <option value="1">1 - Lowest</option>
                                <option value="2">2 - Low</option>
                                <option value="3">3 - Medium</option>
                                <option value="4">4 - High</option>
                                <option value="5">5 - Highest</option>
                                <option value="6">6 - Critical</option>
                            </select>
                            <div class="form-text">Priority level of this camera (affects processing order)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-threshold-btn">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Dashboard JavaScript for Real-Time Crowd Detection System

        // Global variables
        let crowdTrendsChart = null;
        let fpsChart = null;
        let latencyChart = null;
        let roiCanvas = null;
        let roiContext = null;
        let roiPoints = [];
        let currentCameraId = null;
        let cameraImage = null;
        let isDragging = false;
        let dragPointIndex = -1;
        let canvasScale = 1;
        let canvasOffset = { x: 0, y: 0 };
        let roiTemplates = {};

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize charts
            initCharts();
            
            // Load cameras
            loadCameras();
            
            // Setup event listeners
            setupEventListeners();
            
            // Request notification permissions
            if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
                // Wait a moment to request permission for better user experience
                setTimeout(() => {
                    Notification.requestPermission();
                }, 3000);
            }
            
            // Start data refresh
            setInterval(refreshData, 5000);
            
            // Get alert sound toggle state from localStorage
            const alertSoundEnabled = localStorage.getItem('alertSoundEnabled') !== 'false';
            document.getElementById('alert-sound-toggle').checked = alertSoundEnabled;
            
            // Handle toggle changes
            document.getElementById('alert-sound-toggle').addEventListener('change', function(e) {
                localStorage.setItem('alertSoundEnabled', e.target.checked);
            });
        });

        // Initialize charts
        function initCharts() {
            // Chart.js global defaults
            Chart.defaults.font.family = "'Segoe UI', 'Arial', sans-serif";
            Chart.defaults.font.size = 12;
            Chart.defaults.plugins.legend.display = false;
            Chart.defaults.elements.line.tension = 0.4;
            Chart.defaults.elements.line.borderWidth = 2;
            Chart.defaults.elements.point.radius = 3;
            Chart.defaults.elements.point.hoverRadius = 5;

            // Initialize Crowd Trends Chart
            const crowdCtx = document.getElementById('crowdTrendsChart').getContext('2d');
            const gradientFill = crowdCtx.createLinearGradient(0, 0, 0, 400);
            gradientFill.addColorStop(0, 'rgba(13, 110, 253, 0.2)');
            gradientFill.addColorStop(1, 'rgba(13, 110, 253, 0)');

            crowdTrendsChart = new Chart(crowdCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Crowd Count',
                        data: [],
                        borderColor: '#0d6efd',
                        backgroundColor: gradientFill,
                        fill: true,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#0d6efd',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            borderColor: 'rgba(255, 255, 255, 0.1)',
                            borderWidth: 1,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            displayColors: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
            
            // Initialize FPS Chart
            const fpsCtx = document.getElementById('fpsChart').getContext('2d');
            const fpsGradient = fpsCtx.createLinearGradient(0, 0, 0, 400);
            fpsGradient.addColorStop(0, 'rgba(40, 167, 69, 0.2)');
            fpsGradient.addColorStop(1, 'rgba(40, 167, 69, 0)');

            fpsChart = new Chart(fpsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'FPS',
                        data: [],
                        borderColor: '#28a745',
                        backgroundColor: fpsGradient,
                        fill: true,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#28a745',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            displayColors: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                        }
                        }
                    }
                }
            });
            
            // Initialize Latency Chart
            const latencyCtx = document.getElementById('latencyChart').getContext('2d');
            const latencyGradient = latencyCtx.createLinearGradient(0, 0, 0, 400);
            latencyGradient.addColorStop(0, 'rgba(255, 193, 7, 0.2)');
            latencyGradient.addColorStop(1, 'rgba(255, 193, 7, 0)');

            latencyChart = new Chart(latencyCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Latency',
                        data: [],
                        borderColor: '#ffc107',
                        backgroundColor: latencyGradient,
                        fill: true,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#ffc107',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 },
                            displayColors: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }

        // Set up event listeners
        function setupEventListeners() {
            // Add camera button
            document.getElementById('save-camera-btn').addEventListener('click', addCamera);
            
            // Reset cameras button
            document.getElementById('reset-cameras-btn').addEventListener('click', resetCameras);
            
            // Reset alerts button
            document.getElementById('reset-alerts-btn').addEventListener('click', resetAlerts);
            
            // Test camera button
            document.getElementById('test-camera-btn').addEventListener('click', testCameraConnection);
            
            // ROI canvas setup - we'll add the click handler when the modal opens instead
            roiCanvas = document.getElementById('roi-canvas');
            if (roiCanvas) {
                roiContext = roiCanvas.getContext('2d');
            }
            
            // Setup camera alert controls after loading cameras
            loadCameras().then(() => {
                setupCameraAlertControls();
            });
        }

        // Load cameras from API
        function loadCameras() {
            return new Promise((resolve, reject) => {
                fetch('/api/cameras')
                    .then(response => response.json())
                    .then(cameras => {
                        renderCameraCards(cameras);
                        resolve(); // Resolve the promise after rendering is complete
                    })
                    .catch(error => {
                        console.error('Error loading cameras:', error);
                        reject(error); // Reject the promise if there's an error
                    });
            });
        }

        // Render camera cards
        function renderCameraCards(cameras) {
            const container = document.getElementById('camera-feed-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Check if cameras is empty
            if (Object.keys(cameras).length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No cameras added yet. Click the "Add Camera" button to add a camera.</div></div>';
                return;
            }
            
            // Create card for each camera
            for (const [cameraId, camera] of Object.entries(cameras)) {
                // Determine priority badge color
                let priorityBadgeClass = 'bg-secondary';
                let priorityText = 'Medium';
                
                switch(camera.priority) {
                    case 1:
                        priorityBadgeClass = 'bg-secondary';
                        priorityText = 'Lowest';
                        break;
                    case 2:
                        priorityBadgeClass = 'bg-info';
                        priorityText = 'Low';
                        break;
                    case 3:
                        priorityBadgeClass = 'bg-primary';
                        priorityText = 'Medium';
                        break;
                    case 4:
                        priorityBadgeClass = 'bg-warning';
                        priorityText = 'High';
                        break;
                    case 5:
                        priorityBadgeClass = 'bg-danger';
                        priorityText = 'Critical';
                        break;
                    case 6:
                        priorityBadgeClass = 'bg-dark';
                        priorityText = 'Critical';
                        break;
                }
                
                const cardDiv = document.createElement('div');
                cardDiv.className = 'col-md-6 col-lg-4';
                cardDiv.innerHTML = `
                    <div id="camera-card-${cameraId}" class="camera-card shadow-lg position-relative" style="background: linear-gradient(135deg, #f8fafc 60%, #e3e9f7 100%); border: none;">
                        <div class="camera-card-header d-flex align-items-center justify-content-between px-3 py-2" style="background: linear-gradient(90deg, #0d6efd 60%, #6ea8fe 100%); border-top-left-radius: 10px; border-top-right-radius: 10px;">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-camera-video-fill text-white" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-white" style="font-size: 1.1rem; letter-spacing: 0.5px;">${camera.name} <small class="ms-2 opacity-75">(ID: ${cameraId})</small></span>
                            </div>
                            <span class="badge ${priorityBadgeClass} px-3 py-1" style="font-size: 0.95rem;">${priorityText} Priority</span>
                        </div>
                        <div class="camera-feed-container position-relative" style="background: #222;">
                            <img src="/video_feed/${cameraId}" class="camera-feed" alt="${camera.name}" style="border-bottom: 1px solid #e3e9f7; min-height: 120px; object-fit: cover; width: 100%;">
                            <span class="position-absolute badge ${priorityBadgeClass}" style="top: 12px; right: 12px; opacity: 0.85;">${priorityText}</span>
                        </div>
                        <div class="camera-info p-3">
                            <div class="row align-items-center mb-2">
                                <div class="col-6 d-flex align-items-center gap-2">
                                    <i class="bi bi-people-fill text-primary"></i>
                                    <span id="crowd-count-${cameraId}" class="crowd-count normal">Crowd: 0</span>
                                </div>
                                <div class="col-6 text-end">
                                    <span id="threshold-${cameraId}" class="badge rounded-pill bg-light text-dark border">Threshold: ${camera.threshold || 'Not set'}</span>
                            </div>
                                </div>
                            <div class="row mb-2">
                                <div class="col-6 small text-muted">
                                    <i class="bi bi-cpu me-1"></i> <span id="model-info-${cameraId}">Model: -</span>
                            </div>
                                <div class="col-6 small text-muted text-end">
                                    <i class="bi bi-bar-chart-fill me-1"></i> <span id="density-threshold-${cameraId}">Density: ${camera.density_threshold || '-'}</span>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6 small text-muted">
                                    <i class="bi bi-gear-wide-connected me-1"></i> <span id="mode-${cameraId}">Mode: YOLO</span>
                                </div>
                                <div class="col-6 small text-muted text-end">
                                    <i class="bi bi-award me-1"></i> <span id="priority-${cameraId}">Priority: ${camera.priority || '-'}</span>
                                </div>
                            </div>
                            <div class="row mb-2 g-2">
                                <div class="col-6">
                                    <span class="badge bg-success bg-opacity-10 text-success w-100"><i class="bi bi-speedometer2 me-1"></i>Target FPS: <span class="target-fps">${camera.fps || '30'}</span></span>
                                </div>
                                <div class="col-6">
                                    <span class="badge bg-info bg-opacity-10 text-info w-100"><i class="bi bi-activity me-1"></i>Actual FPS: <span class="actual-fps">0.0</span></span>
                                </div>
                            </div>
                            <div class="row mb-2 g-2">
                                <div class="col-12">
                                    <span class="badge bg-warning bg-opacity-10 text-warning w-100"><i class="bi bi-clock-history me-1"></i>Processing: <span class="latency-value">0.0</span> ms</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3 gap-2">
                                <div class="form-check form-switch">
                                    <input class="form-check-input camera-alert-toggle" type="checkbox" id="alert-sound-toggle-${cameraId}" checked>
                                    <label class="form-check-label small" for="alert-sound-toggle-${cameraId}">Alert Sound</label>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm test-alert-btn" data-camera-id="${cameraId}">
                                    <i class="bi bi-volume-up"></i> Test
                                </button>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3 gap-2">
                                <button class="btn btn-outline-primary btn-sm set-roi-btn d-flex align-items-center gap-1" data-camera-id="${cameraId}"><i class="bi bi-crop"></i> ROI</button>
                                <button class="btn btn-outline-secondary btn-sm set-threshold-btn d-flex align-items-center gap-1" data-camera-id="${cameraId}" data-bs-toggle="modal" data-bs-target="#thresholdModal"><i class="bi bi-sliders"></i> Settings</button>
                                <button class="btn btn-outline-danger btn-sm remove-camera-btn d-flex align-items-center gap-1" data-camera-id="${cameraId}"><i class="bi bi-trash"></i> Remove</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(cardDiv);
                
                // Add event listeners after appending the card
                const testBtn = cardDiv.querySelector('.test-alert-btn');
                if (testBtn) {
                    testBtn.addEventListener('click', function() {
                        const alertSound = document.getElementById('alert-sound');
                        if (alertSound) {
                            alertSound.currentTime = 0;
                            alertSound.play().catch(err => {
                                console.error('Error playing test sound:', err);
                                showToast('Please interact with the page first to enable sounds', 'warning');
                            });
                        }
                    });
                }
            }
            
            // Add event listeners to buttons
            document.querySelectorAll('.set-roi-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const cameraId = this.getAttribute('data-camera-id');
                    openRoiModal(cameraId);
                });
            });
            
            document.querySelectorAll('.remove-camera-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const cameraId = this.getAttribute('data-camera-id');
                    removeCamera(cameraId);
                });
            });
        }

        // Add new camera
        function addCamera() {
            const cameraId = document.getElementById('camera-id').value;
            const cameraName = document.getElementById('camera-name').value;
            const cameraUrl = document.getElementById('camera-url').value;
            const threshold = parseInt(document.getElementById('camera-threshold').value);
            const densityThreshold = parseInt(document.getElementById('density-threshold').value);
            const priority = parseInt(document.getElementById('camera-priority').value);
            const fps = parseInt(document.getElementById('camera-fps').value);
            
            if (!cameraId || !cameraName || !cameraUrl) {
                alert('Please fill all required fields');
                return;
            }
            
            const cameraData = {
                id: cameraId,
                name: cameraName,
                url: cameraUrl,
                threshold: threshold,
                density_threshold: densityThreshold,
                priority: priority,
                fps: fps
            };
            
            fetch('/api/add_camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(cameraData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Close modal and reload cameras
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addCameraModal'));
                    modal.hide();
                    loadCameras();
                    
                    // Clear form
                    document.getElementById('add-camera-form').reset();
                    
                    // Show success message
                    alert('Camera added successfully!');
                } else {
                    alert('Error adding camera: ' + (result.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error adding camera:', error);
                alert('Error adding camera: ' + error.message);
            });
        }

        // Remove camera
        function removeCamera(cameraId) {
            if (!confirm(`Are you sure you want to remove camera ${cameraId}?`)) {
                return;
            }
            
            fetch('/api/remove_camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: cameraId })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    loadCameras();
                } else {
                    alert('Error removing camera: ' + (result.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error removing camera:', error);
                alert('Error removing camera');
            });
        }

        // Open ROI modal with enhanced feed loading
        function openRoiModal(cameraId) {
            currentCameraId = cameraId;
            roiPoints = [];
            
            // Get the canvas container for better sizing
            const canvasContainer = document.querySelector('.canvas-container');
            const loadingIndicator = document.getElementById('canvas-loading-indicator');
            
            // Try to pre-fetch the feed for better reliability
            enhanceVideoFeed(cameraId);
            
            // Show loading indicator
            if (loadingIndicator) {
                loadingIndicator.style.display = 'block';
                loadingIndicator.innerHTML = `
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p>Loading camera feed...</p>
                    <div class="progress mt-2" style="height: 5px; width: 200px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                    </div>
                `;
            }
            
            // Create a fallback timeout to handle loading failures
            const loadingTimeout = setTimeout(() => {
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = `
                        <div class="alert alert-warning">
                            <p>Camera feed loading is taking longer than expected.</p>
                            <div class="mt-2">
                                <button id="retry-camera-load" class="btn btn-sm btn-primary me-2">Retry</button>
                                <button id="use-fallback-image" class="btn btn-sm btn-secondary me-2">Use Static Image</button>
                                <a href="/video_feed/${cameraId}?direct=true" target="_blank" class="btn btn-sm btn-info">Direct Feed</a>
                            </div>
                        </div>
                    `;
                    
                    // Add retry handler
                    document.getElementById('retry-camera-load').addEventListener('click', () => {
                        openRoiModal(cameraId);
                    });
                    
                    // Add fallback handler
                    document.getElementById('use-fallback-image').addEventListener('click', () => {
                        useStaticCanvas(cameraId);
                    });
                }
            }, 8000); // 8 second timeout
            
            // Show the modal early to prevent UI lag
            const roiModal = new bootstrap.Modal(document.getElementById('roiModal'));
            roiModal.show();
            
            // Resize canvas and prepare for ROI selection
            const img = new Image();
            
            // Make sure the image loads with proper CORS settings
            img.crossOrigin = "Anonymous";
            
            // Add error handling for image loading
            img.onerror = function(err) {
                console.error('Error loading camera feed image:', err);
                const errorMessage = document.getElementById('roi-error-message');
                if (errorMessage) {
                    errorMessage.innerHTML = `
                        <div class="alert alert-danger">
                            <h5>Error Loading Camera Feed</h5>
                            <p>Failed to load the camera feed. This could be due to:</p>
                            <ul>
                                <li>CORS (Cross-Origin Resource Sharing) restrictions</li>
                                <li>Camera feed being unavailable</li>
                                <li>Network connectivity issues</li>
                            </ul>
                            <div class="mt-2">
                                <button id="retry-camera-load" class="btn btn-sm btn-primary me-2">Retry</button>
                                <button id="use-fallback-image" class="btn btn-sm btn-secondary me-2">Use Static Image</button>
                                <a href="/video_feed/${cameraId}?direct=true" target="_blank" class="btn btn-sm btn-info">Direct Feed</a>
                            </div>
                        </div>
                    `;
                    
                    // Add retry handler
                    document.getElementById('retry-camera-load').addEventListener('click', () => {
                        openRoiModal(cameraId);
                    });
                    
                    // Add fallback handler
                    document.getElementById('use-fallback-image').addEventListener('click', () => {
                        useStaticCanvas(cameraId);
                    });
                }
            };
            
            // Add CORS error detection
            img.onabort = function() {
                console.error('Image loading aborted - possible CORS issue');
                const errorMessage = document.getElementById('roi-error-message');
                if (errorMessage) {
                    errorMessage.innerHTML = `
                        <div class="alert alert-warning">
                            <h5>CORS Issue Detected</h5>
                            <p>The camera feed could not be loaded due to CORS restrictions. Please try one of the following:</p>
                            <ul>
                                <li>Check if the camera server allows cross-origin requests</li>
                                <li>Use the direct feed option to view the camera in a new tab</li>
                                <li>Use the static image option as a fallback</li>
                            </ul>
                            <div class="mt-2">
                                <button id="retry-camera-load" class="btn btn-sm btn-primary me-2">Retry</button>
                                <button id="use-fallback-image" class="btn btn-sm btn-secondary me-2">Use Static Image</button>
                                <a href="/video_feed/${cameraId}?direct=true" target="_blank" class="btn btn-sm btn-info">Direct Feed</a>
                            </div>
                        </div>
                    `;
                    
                    // Add retry handler
                    document.getElementById('retry-camera-load').addEventListener('click', () => {
                        openRoiModal(cameraId);
                    });
                    
                    // Add fallback handler
                    document.getElementById('use-fallback-image').addEventListener('click', () => {
                        useStaticCanvas(cameraId);
                    });
                }
            };
            
            // Create a unique timestamp to prevent caching
            const timestamp = Date.now();
            const imageUrl = `/video_feed/${cameraId}?t=${timestamp}`;
            
            // Set image source to camera feed with CORS settings
            console.log(`Loading image from URL: ${imageUrl}`);
            img.src = imageUrl;
            
            img.onload = function() {
                // Clear the timeout since image loaded successfully
                clearTimeout(loadingTimeout);
                console.log('Camera feed image loaded successfully', this.width, this.height);
                
                // Check if image has valid dimensions
                if (this.width < 2 || this.height < 2) {
                    console.error('Invalid image dimensions:', this.width, this.height);
                    img.onerror(new Error('Invalid image dimensions'));
                    return;
                }
                
                // Store original image dimensions for coordinate conversion
                this.originalWidth = this.width;
                this.originalHeight = this.height;
                
                // Set a fixed width for better UI experience
                const containerWidth = canvasContainer.clientWidth;
                const aspectRatio = this.height / this.width;
                
                // Set canvas dimensions to maintain aspect ratio within container
                roiCanvas.width = containerWidth;
                roiCanvas.height = containerWidth * aspectRatio;
                
                try {
                // Draw image on canvas
                    roiContext.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
                roiContext.drawImage(this, 0, 0, roiCanvas.width, roiCanvas.height);
                    
                    // IMPORTANT: Store image data to ensure it's not lost
                                    
                    console.log('Storing image data');
                    window.capturedImageData = roiContext.getImageData(0, 0, roiCanvas.width, roiCanvas.height);
                
                // Store image for redrawing
                cameraImage = this;
                
                    // Reset canvas state
                    canvasScale = 1;
                    canvasOffset = { x: 0, y: 0 };
                
                // Set up event handlers on ROI modal buttons
                setupRoiModalButtons();
                
                    // Update ROI statistics
                    updateRoiStatistics();
                    
                    // Hide loading indicator manually
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'none';
                    }
                } catch (e) {
                    console.error('Error drawing on canvas:', e);
                    img.onerror(e);
                }
            };
            
            // Try multiple approaches to load the image
            tryLoadImage(img, cameraId);
        }
        
        // Function to try multiple approaches for loading the image
        function tryLoadImage(img, cameraId) {
            // Ensure we add a cache-busting parameter
            const timestamp = Date.now();
            // Request a static frame instead of a video stream for ROI selection
            const mainUrl = `/video_feed/${cameraId}?t=${timestamp}&static=true`;
            
            console.log(`Loading camera feed: ${mainUrl}`);
            
            // First try with normal URL
            img.src = mainUrl;
        }
        
        // Fallback function to use a static canvas when the camera feed fails to load
        function useStaticCanvas(cameraId) {
            // Create a simple static canvas with a placeholder
            const canvas = document.getElementById('roi-canvas');
            const context = canvas.getContext('2d');
            const container = document.querySelector('.canvas-container');
            
            // Set dimensions
            canvas.width = container.clientWidth;
            canvas.height = Math.round(container.clientWidth * 0.75); // 4:3 aspect ratio
            
            // Store original dimensions for coordinate conversion
            const originalWidth = canvas.width;
            const originalHeight = canvas.height;
            
            // Create a placeholder image
            const placeholderImg = new Image();
            placeholderImg.onload = function() {
                // Create a "camera offline" background
                context.fillStyle = '#f0f0f0';
                context.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw the placeholder image
                const imgWidth = Math.min(canvas.width, this.width);
                const imgHeight = Math.min(canvas.height, this.height);
                const x = (canvas.width - imgWidth) / 2;
                const y = (canvas.height - imgHeight) / 2;
                
                context.drawImage(this, x, y, imgWidth, imgHeight);
                
                // Add text indicating this is a placeholder
                context.fillStyle = 'rgba(0, 0, 0, 0.7)';
                context.fillRect(0, canvas.height - 40, canvas.width, 40);
                context.font = 'bold 16px Arial';
                context.fillStyle = 'white';
                context.textAlign = 'center';
                context.fillText('Static ROI Mode - Click to Add Points', canvas.width / 2, canvas.height - 15);
                
                // Store dimensions for coordinate conversion
                placeholderImg.originalWidth = originalWidth;
                placeholderImg.originalHeight = originalHeight;
                
                // Store as camera image
                cameraImage = placeholderImg;
                
                // Store the initial image data
                window.capturedImageData = context.getImageData(0, 0, canvas.width, canvas.height);
                
                // Set up ROI functionality
                setupRoiModalButtons();
                setupRoiCanvasHandlers();
                updateRoiStatistics();
                
                // Hide loading indicator
                const loadingIndicator = document.getElementById('canvas-loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            };
            
            // Use a simple grid pattern as placeholder
            placeholderImg.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQwIiBoZWlnaHQ9IjQ4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cGF0dGVybiBpZD0iZ3JpZCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBwYXR0ZXJuVW5pdHM9InVzZXJTcGFjZU9uVXNlIj48cGF0aCBkPSJNIDQwIDAgTCAwIDAgMCA0MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZTBlMGUwIiBzdHJva2Utd2lkdGg9IjEiLz48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNmNWY1ZjUiLz48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSJ1cmwoI2dyaWQpIi8+PC9zdmc+';
        }

        // Modified redraw function to ensure image persistence
        function redrawRoiCanvas() {
            if (!roiCanvas || !roiContext) return;
            
            // Clear canvas
            roiContext.clearRect(0, 0, roiCanvas.width, roiCanvas.height);
            
            // Try to redraw the image from the stored image data first if available
            if (window.capturedImageData) {
                try {
                    roiContext.putImageData(window.capturedImageData, 0, 0);
                } catch (e) {
                    console.error('Error restoring image data:', e);
                    // Fall back to drawing from the image object
                    if (cameraImage) {
                        try {
            roiContext.drawImage(cameraImage, 0, 0, roiCanvas.width, roiCanvas.height);
                        } catch (e) {
                            console.error('Error drawing camera image:', e);
                        }
                    }
                }
            } else if (cameraImage) {
                // If no stored image data, draw from the image object
                try {
                    roiContext.drawImage(cameraImage, 0, 0, roiCanvas.width, roiCanvas.height);
                } catch (e) {
                    console.error('Error drawing camera image:', e);
                }
            }
            
            // Draw ROI points and lines
            if (roiPoints.length > 0) {
                // Draw lines connecting points
                roiContext.beginPath();
                
                for (let i = 0; i < roiPoints.length; i++) {
                    const point = roiPoints[i];
                    // Make sure we handle both array format [x,y] and object format {x,y}
                    const pointX = Array.isArray(point) ? point[0] : point.x;
                    const pointY = Array.isArray(point) ? point[1] : point.y;
                    
                    // Scale points from original image dimensions to canvas dimensions
                    const canvasX = pointX * (roiCanvas.width / cameraImage.originalWidth);
                    const canvasY = pointY * (roiCanvas.height / cameraImage.originalHeight);
                    
                    if (i === 0) {
                        roiContext.moveTo(canvasX, canvasY);
                    } else {
                        roiContext.lineTo(canvasX, canvasY);
                    }
                }
                
                // Close the polygon
                if (roiPoints.length > 2) {
                    const firstPoint = roiPoints[0];
                    const firstX = (Array.isArray(firstPoint) ? firstPoint[0] : firstPoint.x) * (roiCanvas.width / cameraImage.originalWidth);
                    const firstY = (Array.isArray(firstPoint) ? firstPoint[1] : firstPoint.y) * (roiCanvas.height / cameraImage.originalHeight);
                    roiContext.lineTo(firstX, firstY);
                    
                    // Fill with semi-transparent color
                    roiContext.fillStyle = 'rgba(255, 0, 0, 0.2)';
                    roiContext.fill();
                }
                
                roiContext.strokeStyle = '#FF0000';
                roiContext.lineWidth = 2;
                roiContext.stroke();
                
                // Draw points
                for (let i = 0; i < roiPoints.length; i++) {
                    const point = roiPoints[i];
                    const pointX = Array.isArray(point) ? point[0] : point.x;
                    const pointY = Array.isArray(point) ? point[1] : point.y;
                    
                    const canvasX = pointX * (roiCanvas.width / cameraImage.originalWidth);
                    const canvasY = pointY * (roiCanvas.height / cameraImage.originalHeight);
                    
                    // Draw outer circle (white with red border)
                    roiContext.beginPath();
                    roiContext.arc(canvasX, canvasY, 8, 0, 2 * Math.PI);
                    roiContext.fillStyle = 'white';
                    roiContext.fill();
                    roiContext.strokeStyle = '#FF0000';
                    roiContext.lineWidth = 2;
                    roiContext.stroke();
                    
                    // Draw inner circle (solid red)
                    roiContext.beginPath();
                    roiContext.arc(canvasX, canvasY, 4, 0, 2 * Math.PI);
                    roiContext.fillStyle = '#FF0000';
                    roiContext.fill();
                    
                    // Draw point number
                    roiContext.font = 'bold 12px Arial';
                    roiContext.fillStyle = 'black';
                    roiContext.textAlign = 'center';
                    roiContext.textBaseline = 'middle';
                    roiContext.fillText((i + 1).toString(), canvasX, canvasY - 15);
                }
            }
        }
        
        // Add ROI point on canvas click with proper image preservation
        function addRoiPoint(event) {
            if (!roiCanvas || !roiContext || !cameraImage) return;
            // Save current canvas state before making changes
            try {
                if (!window.capturedImageData) {
                    window.capturedImageData = roiContext.getImageData(0, 0, roiCanvas.width, roiCanvas.height);
                }
            } catch (e) {
                console.error('Error saving canvas state:', e);
            }
            // Get click coordinates relative to canvas
            const rect = roiCanvas.getBoundingClientRect();
            const scaleX = roiCanvas.width / rect.width;
            const scaleY = roiCanvas.height / rect.height;
            const x = (event.clientX - rect.left) * scaleX;
            const y = (event.clientY - rect.top) * scaleY;
            // Convert to original image coordinates
            const originalX = Math.round(x * (cameraImage.originalWidth / roiCanvas.width));
            const originalY = Math.round(y * (cameraImage.originalHeight / roiCanvas.height));
            // Clamp to image bounds
            const clampedX = Math.max(0, Math.min(originalX, cameraImage.originalWidth - 1));
            const clampedY = Math.max(0, Math.min(originalY, cameraImage.originalHeight - 1));
            // Add the point
            roiPoints.push([clampedX, clampedY]);
            // Redraw canvas
            redrawRoiCanvas();
            // Update statistics
            updateRoiStatistics();
        }
        
        // Handle mouse move for dragging points
        function handleMouseMove(event) {
            if (!isDragging || dragPointIndex === -1 || !roiCanvas || !cameraImage) return;
            // Get mouse position relative to canvas
            const rect = roiCanvas.getBoundingClientRect();
            const x = (event.clientX - rect.left) / canvasScale - canvasOffset.x;
            const y = (event.clientY - rect.top) / canvasScale - canvasOffset.y;
            // Convert to original image coordinates
            const originalX = Math.round(x * (cameraImage.originalWidth / roiCanvas.width));
            const originalY = Math.round(y * (cameraImage.originalHeight / roiCanvas.height));
            // Clamp to image bounds
            const clampedX = Math.max(0, Math.min(originalX, cameraImage.originalWidth - 1));
            const clampedY = Math.max(0, Math.min(originalY, cameraImage.originalHeight - 1));
            // Update point position
            roiPoints[dragPointIndex] = [clampedX, clampedY];
            // Update display
            redrawRoiCanvas();
            updateRoiPointsDisplay();
            updateRoiStatistics();
        }
        
        // Handle mouse up to end dragging
        function handleMouseUp() {
            isDragging = false;
            dragPointIndex = -1;
        }
        
        // Initialize canvas when document is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Find canvas and get context
            roiCanvas = document.getElementById('roi-canvas');
            if (roiCanvas) {
                roiContext = roiCanvas.getContext('2d');
                setupRoiCanvasHandlers();
            }
        });
        
        // Fix the data structure format to ensure compatibility
        function setupRoiCanvasHandlers() {
            // Store a reference to the original image
            let originalImage = null;
            
            // Setup canvas event listeners
            roiCanvas.addEventListener('mousedown', function(e) {
                const rect = roiCanvas.getBoundingClientRect();
                const x = (e.clientX - rect.left) / canvasScale - canvasOffset.x;
                const y = (e.clientY - rect.top) / canvasScale - canvasOffset.y;
                
                // Only add point if Shift key is NOT pressed
                if (!e.shiftKey) {
                    // Make sure to preserve the canvas before adding a point
                    const imgData = roiContext.getImageData(0, 0, roiCanvas.width, roiCanvas.height);
                    
                    // Scale coordinates back to original image dimensions
                    const originalX = Math.round(x * (cameraImage.originalWidth / roiCanvas.width));
                    const originalY = Math.round(y * (cameraImage.originalHeight / roiCanvas.height));
                    
                    // Use the correct data structure format: array of [x,y] instead of {x,y} objects
                    roiPoints.push([originalX, originalY]);
                    
                    // Ensure we redraw the correct way
                    redrawRoiCanvas(true, imgData);
                    
                    // Update statistics
                    updateRoiStatistics();
                }
            });
            
            roiCanvas.addEventListener('mousemove', function(e) {
                // Handle mousemove events if needed
            });
        }
        
        // Update ROI statistics
        function updateRoiStatistics() {
            const pointsCount = roiPoints.length;
            document.getElementById('roi-points-count').textContent = pointsCount;
            
            // Calculate area percentage if we have enough points
            let areaPercent = 0;
            if (pointsCount >= 3 && cameraImage) {
                // Convert points to canvas coordinates for area calculation
                const canvasPoints = roiPoints.map(point => {
                    const x = Array.isArray(point) ? point[0] : point.x;
                    const y = Array.isArray(point) ? point[1] : point.y;
                    return {
                        x: x * (roiCanvas.width / cameraImage.originalWidth),
                        y: y * (roiCanvas.height / cameraImage.originalHeight)
                    };
                });
                
                // Calculate polygon area using shoelace formula
                let area = 0;
                for (let i = 0; i < canvasPoints.length; i++) {
                    const j = (i + 1) % canvasPoints.length;
                    area += canvasPoints[i].x * canvasPoints[j].y;
                    area -= canvasPoints[j].x * canvasPoints[i].y;
                }
                area = Math.abs(area) / 2;
                
                // Calculate percentage
                const totalArea = roiCanvas.width * roiCanvas.height;
                areaPercent = ((area / totalArea) * 100).toFixed(1);
            }
            
            document.getElementById('roi-area-percent').textContent = `${areaPercent}% of frame`;
            
            // Update status
            const statusElement = document.getElementById('roi-status');
            if (pointsCount < 3) {
                statusElement.textContent = 'Incomplete';
                statusElement.className = 'badge bg-warning';
            } else {
                statusElement.textContent = 'Complete';
                statusElement.className = 'badge bg-success';
            }
            
            // Update points list if it exists
            const pointsList = document.getElementById('roi-points-list');
            if (pointsList) {
                pointsList.innerHTML = roiPoints.map((point, index) => {
                    const x = Array.isArray(point) ? point[0] : point.x;
                    const y = Array.isArray(point) ? point[1] : point.y;
                    return `<div class="roi-point">Point ${index + 1}: (${x}, ${y})</div>`;
                }).join('');
            }
        }
        
        function updateRoiPointsList() {
            const pointsList = document.getElementById('roi-points-list');
            pointsList.innerHTML = '';
            
            roiPoints.forEach((point, index) => {
                const pointElement = document.createElement('div');
                pointElement.className = 'd-flex justify-content-between align-items-center mb-2';
                pointElement.innerHTML = `
                    <span>Point ${index + 1}: (${Math.round(point.x)}, ${Math.round(point.y)})</span>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRoiPoint(${index})">
                        <i class="bi bi-x"></i>
                    </button>
                `;
                pointsList.appendChild(pointElement);
            });
        }
        
        function removeRoiPoint(index) {
            roiPoints.splice(index, 1);
            updateRoiPointsList();
            updateRoiStatistics();
            redrawRoiCanvas();
        }
        
        function clearRoiPoints() {
            roiPoints = [];
            updateRoiPointsList();
            updateRoiStatistics();
            redrawRoiCanvas();
        }
        
        function saveRoiTemplate(name) {
            if (!name) {
                name = prompt('Enter template name:');
                if (!name) return;
            }
            
            // Convert points to normalized coordinates before saving
            const normalizedPoints = roiPoints.map(point => {
                const x = Array.isArray(point) ? point[0] : point.x;
                const y = Array.isArray(point) ? point[1] : point.y;
                return {
                    x: x / cameraImage.originalWidth,
                    y: y / cameraImage.originalHeight
                };
            });
            
            roiTemplates[name] = {
                points: normalizedPoints,
                cameraId: currentCameraId,
                timestamp: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('roiTemplates', JSON.stringify(roiTemplates));
            
            // Show success message
            showToast('ROI template saved successfully', 'success');
        }
        
        function loadRoiTemplate(name) {
            if (!name) {
                // Show template selection modal
                let templateList = '';
                for (const [templateName, template] of Object.entries(roiTemplates)) {
                    templateList += `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>${templateName} (${new Date(template.timestamp).toLocaleString()})</span>
                            <div>
                                <button class="btn btn-sm btn-primary me-2" onclick="loadRoiTemplate('${templateName}')">Load</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteRoiTemplate('${templateName}')">Delete</button>
                            </div>
                        </div>
                    `;
                }
                
                // Check if there are any templates
                if (templateList === '') {
                    templateList = '<div class="alert alert-info">No templates available</div>';
                }
                
                const modalContent = `
                    <div class="modal fade" id="templateModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Select ROI Template</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="list-group">
                                        ${templateList}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Remove existing modal if it exists
                const existingModal = document.getElementById('templateModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                document.body.insertAdjacentHTML('beforeend', modalContent);
                const modal = new bootstrap.Modal(document.getElementById('templateModal'));
                modal.show();
                return;
            }
            
            const template = roiTemplates[name];
            if (!template) {
                showToast('Template not found', 'error');
                return;
            }
            
            // Convert normalized coordinates back to actual coordinates
            roiPoints = template.points.map(point => ({
                x: point.x * cameraImage.originalWidth,
                y: point.y * cameraImage.originalHeight
            }));
            
            updateRoiPointsList();
            updateRoiStatistics();
            redrawRoiCanvas();
            
            showToast('ROI template loaded', 'success');
        }
        
        function setupRoiModalButtons() {
            // Clear ROI button
            document.getElementById('clear-roi-btn').addEventListener('click', clearRoiPoints);
            
            // Save ROI button
            document.getElementById('save-roi-btn').addEventListener('click', () => {
                if (roiPoints.length < 3) {
                    showToast('ROI must have at least 3 points', 'error');
                    return;
                }
                saveRoiTemplate();
            });
            
            // Save ROI As button
            document.getElementById('save-roi-as-btn').addEventListener('click', () => {
                if (roiPoints.length < 3) {
                    showToast('ROI must have at least 3 points', 'error');
                    return;
            }
                const name = prompt('Enter template name:');
                if (name) {
                    saveRoiTemplate(name);
            }
            });
            
            // Load ROI Template button
            document.getElementById('load-roi-template-btn').addEventListener('click', () => loadRoiTemplate());
            
            // Full Frame ROI button
            document.getElementById('full-frame-roi-btn').addEventListener('click', () => {
                if (!cameraImage) {
                    showToast('Camera image not loaded', 'error');
                    return;
                }
                
                // Use original image dimensions for full frame
                roiPoints = [
                    { x: 0, y: 0 },
                    { x: cameraImage.originalWidth, y: 0 },
                    { x: cameraImage.originalWidth, y: cameraImage.originalHeight },
                    { x: 0, y: cameraImage.originalHeight }
                ];
                
                updateRoiPointsList();
                    updateRoiStatistics();
                        redrawRoiCanvas();
                showToast('Full frame ROI applied', 'success');
            });
            
            // Apply ROI button
            document.getElementById('apply-roi-btn').addEventListener('click', () => {
                if (roiPoints.length < 3) {
                    showToast('ROI must have at least 3 points', 'error');
                    return;
                }
                // Define original and target dimensions
                const originalWidth = 1920;
                const originalHeight = 1080;
                const targetWidth = 640;
                const targetHeight = 480; // Clamp to 480, not 640!

                // Calculate scaling factors
                const scaleX = targetWidth / originalWidth;
                const scaleY = targetHeight / originalHeight;

                // Validate and scale points to target dimensions
                let validPoints = roiPoints.map(point => {
                    const x = Array.isArray(point) ? point[0] : point.x;
                    const y = Array.isArray(point) ? point[1] : point.y;
                    // Scale points to target dimensions
                    const scaledX = Math.round(x * scaleX);
                    const scaledY = Math.round(y * scaleY);
                    return [scaledX, scaledY];
                });
                // Clamp points to frame bounds
                validPoints = clampRoiPoints(validPoints, targetWidth, targetHeight);
                console.log('Clamped ROI points before API call:', validPoints);
                // Show loading indicator
                const applyBtn = document.getElementById('apply-roi-btn');
                const originalText = applyBtn.innerHTML;
                applyBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Applying...';
                applyBtn.disabled = true;
                // Send ROI points to server
                const payload = {
                    id: currentCameraId,
                    roi: validPoints
                };
                console.log('Sending ROI payload:', payload);
                fetch('/api/set_roi', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(async response => {
                    console.log('set_roi response status:', response.status);
                    let data;
                    try {
                        data = await response.clone().json();
                        console.log('set_roi response body:', data);
                    } catch (e) {
                        const text = await response.text();
                        console.log('set_roi response (non-JSON):', text);
                        data = { success: false, message: text };
                    }
                    if (!response.ok) {
                        throw new Error(data.message || `HTTP error! status: ${response.status}`);
                    }
                    return data;
                })
                .then(data => {
                    if (data.success) {
                        showToast('ROI applied successfully', 'success');
                        // Close the modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('roiModal'));
                        if (modal) {
                            modal.hide();
                        }
                    } else {
                        throw new Error(data.message || 'Failed to apply ROI');
                    }
                })
                .catch(error => {
                    console.error('Error applying ROI:', error);
                    showToast(error.message || 'Error applying ROI', 'error');
                })
                .finally(() => {
                    // Reset button state
                    applyBtn.innerHTML = originalText;
                    applyBtn.disabled = false;
                });
            });
        }

        // Load saved templates
        try {
            const savedTemplates = localStorage.getItem('roiTemplates');
            if (savedTemplates) {
                roiTemplates = JSON.parse(savedTemplates);
            }
        } catch (error) {
            console.error('Error loading ROI templates:', error);
        }

        // Refresh data
        function refreshData() {
            // Update crowd data
            fetch('/api/crowd_data')
                .then(response => response.json())
                .then(data => {
                    updateCrowdData(data);
                    updateCrowdChart(data);
                })
                .catch(error => {
                    console.error('Error fetching crowd data:', error);
                });
            
            // Update alerts
            fetch('/api/alerts')
                .then(response => response.json())
                .then(alerts => {
                    updateAlerts(alerts);
                })
                .catch(error => {
                    console.error('Error fetching alerts:', error);
                });
            
            // Update performance data
            fetch('/api/performance')
                .then(response => response.json())
                .then(data => {
                    updatePerformanceChart(data);
                })
                .catch(error => {
                    console.error('Error fetching performance data:', error);
                });
        }

        // Update crowd data display
        function updateCrowdData(data) {
            // Get all current camera cards
            const existingCameraIds = Array.from(document.querySelectorAll('[id^="camera-card-"]'))
                .map(el => el.id.replace('camera-card-', ''));
            
            // Only update data for cameras that still exist in the DOM
            for (const [cameraId, cameraData] of Object.entries(data)) {
                // Skip if this camera was removed from DOM
                if (!existingCameraIds.includes(cameraId)) {
                    continue;
                }
                
                // --- Crowd Count ---
                const countElement = document.getElementById(`crowd-count-${cameraId}`);
                if (countElement) {
                    countElement.textContent = `Crowd Count: ${cameraData.current_count}`;
                }
                // --- Target FPS ---
                const cardElement = document.getElementById(`camera-card-${cameraId}`);
                if (cardElement) {
                    // Target FPS
                    const targetFpsSpan = cardElement.querySelector('.target-fps');
                    if (targetFpsSpan && cameraData.fps && cameraData.fps.target !== undefined) {
                        targetFpsSpan.textContent = cameraData.fps.target;
                    }
                    // Actual FPS
                    const actualFpsSpan = cardElement.querySelector('.actual-fps');
                    if (actualFpsSpan && cameraData.fps && cameraData.fps.actual !== undefined) {
                        actualFpsSpan.textContent = cameraData.fps.actual.toFixed(1);
                    }
                    // Processing Time
                    const latencyValue = cardElement.querySelector('.latency-value');
                    if (latencyValue && cameraData.latency !== undefined) {
                            latencyValue.textContent = (cameraData.latency * 1000).toFixed(1);
                        }
                    }
                // --- Detection Mode ---
                const modeElement = document.getElementById(`mode-${cameraId}`);
                    if (modeElement && cameraData.detection_mode) {
                        modeElement.textContent = cameraData.detection_mode;
                    }
                // --- Threshold coloring ---
                if (countElement) {
                    const thresholdElement = document.getElementById(`threshold-${cameraId}`);
                    const threshold = thresholdElement ? parseInt(thresholdElement.textContent) : 0;
                    if (threshold > 0) {
                        if (cameraData.current_count >= threshold) {
                            countElement.className = 'crowd-count mb-2 danger';
                        } else if (cameraData.current_count >= threshold * 0.8) {
                            countElement.className = 'crowd-count mb-2 warning';
                        } else {
                            countElement.className = 'crowd-count mb-2 normal';
                        }
                    }
                }
                // --- Card offline/online status (unchanged) ---
                // ... existing code ...
                // --- Model Info ---
                const modelInfoElement = document.getElementById(`model-info-${cameraId}`);
                if (modelInfoElement) {
                    let modelText = '-';
                    let transitionText = '';
                    if (cameraData.model && cameraData.detection_mode) {
                        if (cameraData.hybrid) {
                            modelText = `${cameraData.model} (hybrid)`;
                        } else {
                            modelText = `${cameraData.model}`;
                        }
                    } else if (cameraData.model) {
                        modelText = cameraData.model;
                    } else if (cameraData.detection_mode) {
                        modelText = cameraData.detection_mode;
                    }
                    // Show transition percentage if present and in transition
                    if (cameraData.transition !== undefined && cameraData.transition > 0 && cameraData.transition < 1) {
                        const percent = Math.round(cameraData.transition * 100);
                        transitionText = ` <span class='badge bg-info text-dark ms-2'>${percent}% transition</span>`;
                    }
                    modelInfoElement.innerHTML = `Model: ${modelText}${transitionText}`;
                }
                // --- Density Threshold ---
                const densityElement = document.getElementById(`density-threshold-${cameraId}`);
                if (densityElement && cameraData.density_threshold !== undefined) {
                    densityElement.textContent = `Density: ${cameraData.density_threshold}`;
                } else if (densityElement) {
                    densityElement.textContent = 'Density: -';
                }
            }
        }

        // Update crowd trends chart
        function updateCrowdChart(data) {
            if (!crowdTrendsChart) return;
            
            // Reset datasets
            crowdTrendsChart.data.datasets = [];
            
            // Add dataset for each camera
            let maxDataPoints = 0;
            for (const [cameraId, cameraData] of Object.entries(data)) {
                if (!cameraData.history || cameraData.history.length === 0) continue;
                
                // Create dataset for this camera
                const dataset = {
                    label: `Camera ${cameraId}`,
                    data: cameraData.history.map(h => h.count),
                    borderColor: getRandomColor(),
                    tension: 0.1
                };
                
                crowdTrendsChart.data.datasets.push(dataset);
                
                // Update max data points
                maxDataPoints = Math.max(maxDataPoints, cameraData.history.length);
            }
            
            // Update labels (times)
            if (maxDataPoints > 0 && data[Object.keys(data)[0]].history) {
                crowdTrendsChart.data.labels = data[Object.keys(data)[0]].history.map(h => h.datetime);
            }
            
            // Update chart
            crowdTrendsChart.update();
        }

        // Update performance chart
        function updatePerformanceChart(data) {
            if (!fpsChart || !latencyChart) return;
            
            // Update FPS chart
            if (data.fps && data.fps.length > 0) {
                fpsChart.data.labels = data.fps.map(item => {
                    const time = new Date(item.timestamp * 1000);
                    return time.toLocaleTimeString();
                });
                fpsChart.data.datasets[0].data = data.fps.map(item => item.value);
                fpsChart.update();
            }
            
            // Update latency chart
            if (data.latency && data.latency.length > 0) {
                latencyChart.data.labels = data.latency.map(item => {
                    const time = new Date(item.timestamp * 1000);
                    return time.toLocaleTimeString();
                });
                latencyChart.data.datasets[0].data = data.latency.map(item => item.value * 1000); // Convert to ms
                latencyChart.update();
            }
        }

        // Update alerts in the UI
        function updateAlerts(alerts) {
            const summaryContainer = document.getElementById('alerts-summary');
            const camerasContainer = document.getElementById('alerts-by-camera');
            
            if (!summaryContainer || !camerasContainer) return;
            
            // Check if alerts is empty
            if (alerts.length === 0) {
                summaryContainer.innerHTML = '<div class="alert alert-info bg-white bg-opacity-25 border-0">No active alerts.</div>';
                camerasContainer.innerHTML = '';
                document.getElementById('total-alerts-count').textContent = '0';
                updateSidebarAlertBadge(0); // Update sidebar badge when no alerts
                return;
            }
            
            // Update total count with animation
            const totalCountElement = document.getElementById('total-alerts-count');
            totalCountElement.textContent = alerts.length;
            totalCountElement.classList.add('count-update');
            setTimeout(() => totalCountElement.classList.remove('count-update'), 300);
            
            // Update sidebar badge
            updateSidebarAlertBadge(alerts.length);
            
            // Group alerts by camera
            const alertsByCameraId = {};
            alerts.forEach(alert => {
                if (!alertsByCameraId[alert.camera_id]) {
                    alertsByCameraId[alert.camera_id] = [];
                }
                alertsByCameraId[alert.camera_id].push(alert);
            });
            
            // Create summary table
            let summaryHTML = `
                <div class="table-responsive">
                    <table class="table table-hover bg-white bg-opacity-10 rounded">
                <thead>
                    <tr>
                        <th>Camera</th>
                        <th>Count</th>
                        <th>Severity</th>
                        <th>Time</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                        <tbody>
            `;
            
            Object.entries(alertsByCameraId).forEach(([cameraId, cameraAlerts]) => {
                const latestAlert = cameraAlerts[0];
                const severityClass = getSeverityClass(latestAlert.severity);
                
                summaryHTML += `
                    <tr class="align-middle">
                        <td>${latestAlert.camera_name || `Camera ${cameraId}`}</td>
                        <td>${latestAlert.crowd_count} / ${latestAlert.threshold}</td>
                        <td><span class="alert-severity ${latestAlert.severity.toLowerCase()}">${latestAlert.severity}</span></td>
                        <td>${formatTime(latestAlert.datetime)}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-light" onclick="scrollToCamera('${cameraId}')">
                            View Details
                        </button>
                    </td>
                    </tr>
                `;
            });
            
            summaryHTML += '</tbody></table></div>';
            summaryContainer.innerHTML = summaryHTML;
            
            // Create camera-specific alert cards
            camerasContainer.innerHTML = '';
            Object.entries(alertsByCameraId).forEach(([cameraId, cameraAlerts]) => {
                const card = document.createElement('div');
                card.id = `camera-alert-${cameraId}`;
                card.className = 'camera-alert-card';
                
                const latestAlert = cameraAlerts[0];
                const headerColor = getHeaderColor(latestAlert.severity);
                
                card.innerHTML = `
                    <div class="camera-alert-header" style="--header-bg: ${headerColor}">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">${latestAlert.camera_name || `Camera ${cameraId}`}</h5>
                            <span class="badge bg-white text-dark">${cameraAlerts.length} alerts</span>
                        </div>
                    </div>
                    <div class="alert-list p-3">
                        ${cameraAlerts.map(alert => createAlertItem(alert)).join('')}
                    </div>
                `;
                
                camerasContainer.appendChild(card);
            });
        }

        function createAlertItem(alert) {
            return `
                <div class="alert-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <span class="alert-severity ${alert.severity.toLowerCase()}">${alert.severity}</span>
                            <span class="ms-2">Count: ${alert.crowd_count} / ${alert.threshold}</span>
                            </div>
                        <span class="alert-timestamp">${formatTime(alert.datetime)}</span>
                        </div>
                    ${alert.actions && alert.actions.length > 0 ? `
                        <div class="alert-details">
                            <strong>Recommended Actions:</strong>
                            <ul class="alert-action-list">
                                ${alert.actions.map(action => `<li>${action}</li>`).join('')}
                            </ul>
                            </div>
                    ` : ''}
                    </div>
                `;
        }

        function getSeverityClass(severity) {
            switch (severity.toLowerCase()) {
                case 'high': return 'danger';
                case 'medium': return 'warning';
                default: return 'success';
            }
        }

        function getHeaderColor(severity) {
            switch (severity.toLowerCase()) {
                case 'high': return '#dc3545';
                case 'medium': return '#ffc107';
                default: return '#28a745';
            }
        }

        function scrollToCamera(cameraId) {
            const element = document.getElementById(`camera-alert-${cameraId}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                element.classList.add('highlight');
                setTimeout(() => element.classList.remove('highlight'), 2000);
            }
        }

        function expandAllAlerts() {
            document.querySelectorAll('.alert-details').forEach(el => {
                el.style.display = 'block';
            });
        }

        function collapseAllAlerts() {
            document.querySelectorAll('.alert-details').forEach(el => {
                el.style.display = 'none';
            });
        }
        
        // Update sidebar alert badge
        function updateSidebarAlertBadge(alertCount) {
            const sidebarAlertLink = document.querySelector('a[href="#alerts-section"]');
            if (sidebarAlertLink) {
                let badge = sidebarAlertLink.querySelector('.badge');
                if (alertCount > 0) {
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'badge bg-danger ms-2';
                        sidebarAlertLink.appendChild(badge);
                    }
                    badge.textContent = alertCount;
                } else if (badge) {
                    badge.remove();
                }
            }
        }
        
        // Format time for display
        function formatTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        // Generate random color for charts but consistent for same camera ID
        function getRandomColor(seed) {
            if (seed) {
                // Generate consistent color based on seed
                let hash = 0;
                for (let i = 0; i < seed.length; i++) {
                    hash = seed.charCodeAt(i) + ((hash << 5) - hash);
                }
                const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
                return '#' + '00000'.substring(0, 6 - c.length) + c;
            } else {
                // Random color
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }
        }

        // Test camera connection with different URL formats
        function testCameraConnection() {
            const cameraUrl = document.getElementById('camera-url').value;
            
            if (!cameraUrl) {
                alert('Please enter a camera URL first');
                return;
            }
            
            // Show test modal
            const testModal = new bootstrap.Modal(document.getElementById('testCameraModal'));
            testModal.show();
            
            // Reset UI
            document.getElementById('camera-test-spinner').classList.remove('d-none');
            document.getElementById('camera-test-status').textContent = 'Testing camera connection...';
            document.getElementById('camera-test-results').classList.add('d-none');
            document.getElementById('camera-test-table').innerHTML = '';
            
            // Send test request
            fetch('/api/test_camera', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: cameraUrl })
            })
            .then(response => response.json())
            .then(data => {
                // Hide spinner
                document.getElementById('camera-test-spinner').classList.add('d-none');
                
                if (data.success) {
                    // Show results
                    document.getElementById('camera-test-status').textContent = 'Camera connection test completed';
                    document.getElementById('camera-test-results').classList.remove('d-none');
                    
                    // Display best URL recommendation
                    const bestUrlElement = document.getElementById('camera-best-url');
                    if (data.test_results.best_url) {
                        bestUrlElement.textContent = `Recommended URL: ${data.test_results.best_url}`;
                        bestUrlElement.className = 'alert alert-success';
                    } else {
                        bestUrlElement.textContent = 'Could not connect to any camera URL format. Check your camera and network.';
                        bestUrlElement.className = 'alert alert-danger';
                    }
                    
                    // Build results table
                    const tableBody = document.getElementById('camera-test-table');
                    
                    for (const [url, result] of Object.entries(data.test_results.results)) {
                        const row = document.createElement('tr');
                        
                        // URL column
                        const urlCell = document.createElement('td');
                        urlCell.textContent = url;
                        row.appendChild(urlCell);
                        
                        // Connection column
                        const connCell = document.createElement('td');
                        if (result.opened) {
                            connCell.innerHTML = '<span class="badge bg-success">Connected</span>';
                        } else {
                            connCell.innerHTML = '<span class="badge bg-danger">Failed</span>';
                        }
                        row.appendChild(connCell);
                        
                        // Frame read column
                        const frameCell = document.createElement('td');
                        if (result.frame_read) {
                            frameCell.innerHTML = '<span class="badge bg-success">Success</span>';
                        } else {
                            frameCell.innerHTML = '<span class="badge bg-danger">Failed</span>';
                        }
                        row.appendChild(frameCell);
                        
                        // Action column
                        const actionCell = document.createElement('td');
                        const useBtn = document.createElement('button');
                        useBtn.className = 'btn btn-sm btn-primary';
                        useBtn.textContent = 'Use';
                        useBtn.addEventListener('click', function() {
                            document.getElementById('camera-url').value = url;
                            testModal.hide();
                        });
                        
                        actionCell.appendChild(useBtn);
                        row.appendChild(actionCell);
                        
                        // Add highlight to recommended row
                        if (url === data.test_results.best_url) {
                            row.className = 'table-success';
                        }
                        
                        tableBody.appendChild(row);
                    }
                } else {
                    document.getElementById('camera-test-status').textContent = 'Error: ' + (data.message || 'Unknown error');
                }
            })
            .catch(error => {
                document.getElementById('camera-test-spinner').classList.add('d-none');
                document.getElementById('camera-test-status').textContent = 'Error testing camera: ' + error.message;
                console.error('Error testing camera:', error);
            });
        }

        // Reset all cameras
        function resetCameras() {
            if (!confirm('Are you sure you want to reset all camera configurations? This cannot be undone.')) {
                return;
            }
            
            fetch('/api/reset_cameras', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('All camera configurations have been reset successfully.');
                    // Reload cameras
                    loadCameras();
                } else {
                    alert('Error resetting cameras: ' + (result.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error resetting cameras:', error);
                alert('Error resetting cameras: ' + error.message);
            });
        }

        // Reset all alerts
        function resetAlerts() {
            if (!confirm('Are you sure you want to clear all alert history? This cannot be undone.')) {
                return;
            }
            
            fetch('/api/clear_alerts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success) {
                    // Update the UI
                    document.getElementById('alerts-summary').innerHTML = '<div class="alert alert-info">No active alerts.</div>';
                    document.getElementById('alerts-by-camera').innerHTML = '';
                    document.getElementById('total-alerts-count').textContent = '0';
                    
                    // Remove alert badges from sidebar
                    const sidebarAlertLink = document.querySelector('a[href="#alerts-section"]');
                    if (sidebarAlertLink) {
                        const badge = sidebarAlertLink.querySelector('.badge');
                        if (badge) badge.remove();
                    }
                    
                    // Show confirmation
                    alert('All alerts have been cleared successfully.');
                } else {
                    alert('Error clearing alerts: ' + (result.message || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error clearing alerts:', error);
                alert('Error clearing alerts: ' + error.message);
            });
        }

        // Show browser notification for alerts
        function showAlertNotification(alertCount) {
            const title = `Crowd Threshold Alert`;
            const options = {
                body: `${alertCount} new crowd threshold alert${alertCount > 1 ? 's' : ''} detected`,
                icon: '/static/images/alert-icon.svg',  // Try SVG first
                badge: '/static/images/alert-icon.png', // Fallback to PNG for browsers that need it
                vibrate: [200, 100, 200]  // Vibration pattern for mobile devices
            };
            
            try {
                const notification = new Notification(title, options);
                
                // Close the notification after 5 seconds
                setTimeout(() => {
                    notification.close();
                }, 5000);
                
                // Handle click on the notification
                notification.onclick = function() {
                    window.focus();
                    this.close();
                    
                    // Scroll to alerts section
                    document.getElementById('alerts-section').scrollIntoView({
                        behavior: 'smooth'
                    });
                };
            } catch (error) {
                console.error('Error showing notification:', error);
                // Try again with just PNG if SVG failed
                try {
                    const pngOptions = {
                        ...options,
                        icon: '/static/images/alert-icon.png'
                    };
                    const notification = new Notification(title, pngOptions);
                    
                    setTimeout(() => notification.close(), 5000);
                    notification.onclick = function() {
                        window.focus();
                        this.close();
                        document.getElementById('alerts-section').scrollIntoView({
                            behavior: 'smooth'
                        });
                    };
                } catch (e) {
                    console.error('Error showing notification with PNG:', e);
                }
            }
        }

        // Update ROI points display with improved formatting
        function updateRoiPointsDisplay() {
            const pointsEl = document.getElementById('roi-points-list');
            if (!pointsEl) return;
            
            if (roiPoints.length === 0) {
                pointsEl.innerHTML = '<span class="text-muted">No points selected</span>';
                return;
            }
            
            let html = '<div class="mb-2"><strong>Selected Points:</strong></div>';
            html += '<div class="row">';
            
            roiPoints.forEach((point, index) => {
                html += `
                    <div class="col-6 col-md-3 mb-2">
                        <div class="border rounded p-2 ${dragPointIndex === index ? 'border-success bg-light' : ''}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <small>Point ${index + 1}</small><br>
                                    <span class="badge bg-secondary">${point[0]}, ${point[1]}</span>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="removeRoiPoint(${index})">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // Add validation message
            if (roiPoints.length < 3) {
                html += '<div class="alert alert-warning mt-2">You need at least 3 points to create a valid region.</div>';
            } else {
                html += '<div class="alert alert-success mt-2">Valid region selected. Click "Save ROI" to confirm.</div>';
            }
            
            pointsEl.innerHTML = html;
        }
        
        // Zoom and pan functions
        function zoomIn() {
            if (canvasScale < 3) {
                canvasScale *= 1.2;
                redrawRoiCanvas();
            }
        }

        function zoomOut() {
            if (canvasScale > 0.5) {
                canvasScale /= 1.2;
                redrawRoiCanvas();
            }
        }
        
        function resetView() {
            canvasScale = 1;
            canvasOffset = { x: 0, y: 0 };
            redrawRoiCanvas();
        }
        
        // Remove the last added point
        function undoLastPoint() {
            if (roiPoints.length > 0) {
                roiPoints.pop();
            redrawRoiCanvas();
            updateRoiPointsDisplay();
            updateRoiStatistics();
        }
        }

        // Set threshold event handlers
        function setupThresholdEvents() {
            // Set threshold button click
            document.querySelectorAll('.set-threshold-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const cameraId = this.getAttribute('data-camera-id');
                    openThresholdModal(cameraId);
                });
            });
            
            // Save threshold button
            const saveThresholdBtn = document.getElementById('save-threshold-btn');
            if (saveThresholdBtn) {
                saveThresholdBtn.addEventListener('click', saveThreshold);
            }
        }

        // Open threshold modal
        function openThresholdModal(cameraId) {
            document.getElementById('threshold-camera-id').value = cameraId;
            
            // Get current camera data
            fetch('/api/cameras')
                .then(response => response.json())
                .then(cameras => {
                    const camera = cameras[cameraId];
                    if (camera) {
                        // Set threshold value
            const thresholdSpan = document.getElementById(`threshold-${cameraId}`);
                        const currentThreshold = thresholdSpan ? 
                            parseInt(thresholdSpan.textContent.split(': ')[1]) : 
                            camera.threshold || 50;
            document.getElementById('alert-threshold').value = currentThreshold;
                        
                        // Set density threshold value
                        const densityThresholdSpan = document.getElementById(`density-threshold-${cameraId}`);
                        const currentDensityThreshold = densityThresholdSpan ? 
                            parseInt(densityThresholdSpan.textContent.split(': ')[1]) : 
                            camera.density_threshold || 20;
                        document.getElementById('threshold-density').value = currentDensityThreshold;
                        
                        // Set priority value
                        const prioritySpan = document.getElementById(`priority-${cameraId}`);
                        const currentPriority = prioritySpan ? 
                            parseInt(prioritySpan.textContent.split(': ')[1]) : 
                            camera.priority || 3;
                        document.getElementById('camera-priority').value = currentPriority;
                    }
            
            // Show modal
            const thresholdModal = new bootstrap.Modal(document.getElementById('thresholdModal'));
            thresholdModal.show();
                })
                .catch(error => {
                    console.error('Error loading camera settings:', error);
                    alert('Error loading camera settings');
                });
        }

        // Save threshold with immediate UI update
        function saveThreshold() {
            const cameraId = document.getElementById('threshold-camera-id').value;
            const threshold = parseInt(document.getElementById('alert-threshold').value, 10);
            const densityThreshold = parseInt(document.getElementById('threshold-density').value, 10);
            const priority = parseInt(document.getElementById('camera-priority').value, 10);

            if (isNaN(threshold) || isNaN(densityThreshold) || isNaN(priority)) {
                alert('Please enter valid numbers for all fields (Threshold, Density Threshold, Priority).');
                return;
            }

            fetch('/api/set_threshold', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: cameraId,
                    threshold: threshold,
                    density_threshold: densityThreshold,
                    priority: priority
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('thresholdModal'));
                    modal.hide();

                    // Reload camera cards to update all UI elements
                    loadCameras().then(() => {
                        // Show success message
                        showToast('Camera settings updated successfully', 'success');
                    });
                } else {
                    showToast('Error setting thresholds: ' + (result.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error setting thresholds:', error);
                showToast('Error setting thresholds', 'error');
            });
        }

        // Add to setupEventListeners function
        document.addEventListener('DOMContentLoaded', function() {
            // Call setupThresholdEvents after cameras are loaded
            loadCameras()
                .then(() => {
                    setupThresholdEvents();
                })
                .catch(error => {
                    console.error('Error loading cameras:', error);
                    // Handle error appropriately
                });
            
            // Re-setup events when cameras are refreshed
            const originalRenderCameraCards = renderCameraCards;
            renderCameraCards = function(...args) {
                originalRenderCameraCards.apply(this, args);
                setupThresholdEvents();
            };
        });

        // Add direct feed option to enhance compatibility
        function addDirectFeedOption() {
            // Get all camera cards
            const cameraCards = document.querySelectorAll('.camera-card');
            
            cameraCards.forEach(card => {
                const cameraControls = card.querySelector('.d-flex.justify-content-between');
                if (cameraControls) {
                    // Check if direct feed button already exists
                    if (!card.querySelector('.direct-feed-btn')) {
                        // Create direct feed button
                        const directFeedBtn = document.createElement('button');
                        directFeedBtn.className = 'btn btn-sm btn-outline-info direct-feed-btn ms-1';
                        directFeedBtn.innerHTML = '<i class="bi bi-camera-video"></i>';
                        directFeedBtn.title = 'View Direct Feed';
                        
                        // Get camera ID from nearby buttons
                        const roiBtn = card.querySelector('.set-roi-btn');
                        if (roiBtn) {
                            const cameraId = roiBtn.getAttribute('data-camera-id');
                            
                            // Add event listener
                            directFeedBtn.addEventListener('click', function() {
                                window.open(`/video_feed/${cameraId}?direct=true`, '_blank');
                            });
                            
                            // Add button to controls
                            cameraControls.appendChild(directFeedBtn);
                        }
                    }
                }
            });
        }

        // Call direct feed option function after cameras are loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initial setup
            setTimeout(addDirectFeedOption, 2000);
            
            // Add to camera rendering function
            const originalRenderCameraCards = renderCameraCards;
            renderCameraCards = function(...args) {
                originalRenderCameraCards.apply(this, args);
                setTimeout(addDirectFeedOption, 500);
            };
        });
        
        // Enhance the video feed connectivity
        function enhanceVideoFeed(cameraId) {
            console.log('Checking feed for camera:', cameraId);
            
            fetch('/api/check_feed', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: cameraId })
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Feed check result:', result);
                if (result.success) {
                    console.log('Feed is working:', result.message);
                    // Update UI to show feed is working
                    const cameraCard = document.querySelector(`[data-camera-id="${cameraId}"]`);
                    if (cameraCard) {
                        const statusBadge = cameraCard.querySelector('.camera-status');
                        if (statusBadge) {
                            statusBadge.className = 'badge bg-success camera-status';
                            statusBadge.textContent = 'Online';
                        }
                    }
                } else {
                    console.error('Feed check failed:', result.message);
                    // Update UI to show feed error
                    const cameraCard = document.querySelector(`[data-camera-id="${cameraId}"]`);
                    if (cameraCard) {
                        const statusBadge = cameraCard.querySelector('.camera-status');
                        if (statusBadge) {
                            statusBadge.className = 'badge bg-danger camera-status';
                            statusBadge.textContent = 'Error';
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error checking feed:', error);
                // Update UI to show connection error
                const cameraCard = document.querySelector(`[data-camera-id="${cameraId}"]`);
                if (cameraCard) {
                    const statusBadge = cameraCard.querySelector('.camera-status');
                    if (statusBadge) {
                        statusBadge.className = 'badge bg-warning camera-status';
                        statusBadge.textContent = 'Connection Error';
                    }
                }
            });
        }

        // Update delete template function
        function deleteRoiTemplate(name) {
            if (!confirm(`Are you sure you want to delete the template "${name}"?`)) {
                return;
            }
            
            delete roiTemplates[name];
            localStorage.setItem('roiTemplates', JSON.stringify(roiTemplates));
            
            // Show success message
            showToast('Template deleted successfully', 'success');
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('templateModal'));
            if (modal) {
                modal.hide();
            }
            
            // Remove the modal from DOM
            const modalElement = document.getElementById('templateModal');
            if (modalElement) {
                modalElement.remove();
            }
            
            // Reload the template list
            loadRoiTemplate();
        }

        // Update showToast function to handle different types of messages
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            // Set message
            toastMessage.textContent = message;
            
            // Set color based on type
            toast.className = 'toast';
            switch(type) {
                case 'success':
                    toast.classList.add('bg-success', 'text-white');
                    break;
                case 'error':
                    toast.classList.add('bg-danger', 'text-white');
                    break;
                case 'warning':
                    toast.classList.add('bg-warning');
                    break;
                default:
                    toast.classList.add('bg-info', 'text-white');
            }
            
            // Show toast
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Robust image loading function for camera feeds
        function loadCameraImage(img, canvas, onSuccess, onError) {
            // Reset canvas dimensions
            canvas.width = 0;
            canvas.height = 0;
            
            // Set up error handling
            img.onerror = function() {
                console.error('Failed to load image:', img.src);
                if (onError) onError('Failed to load image');
            };
            
            // Set up load handling
            img.onload = function() {
                try {
                    // Check if image has valid dimensions
                    if (img.width === 0 || img.height === 0) {
                        throw new Error('Image has zero dimensions');
                    }
                    
                    // Set canvas dimensions to match image
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Get context and draw image
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    // Verify canvas has valid dimensions
                    if (canvas.width === 0 || canvas.height === 0) {
                        throw new Error('Canvas has zero dimensions after drawing');
                    }
                    
                    // Get image data
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    if (onSuccess) onSuccess(imageData);
                } catch (error) {
                    console.error('Error processing image:', error);
                    if (onError) onError(error.message);
                }
            };
            
            // Set up abort handling
            img.onabort = function() {
                console.warn('Image loading aborted:', img.src);
                if (onError) onError('Image loading aborted');
            };
            
            // Start loading
            img.crossOrigin = 'anonymous';
            img.src = img.src; // Force reload if needed
        }

        // Example usage:
        function processCameraFeed(cameraId) {
            const canvas = document.createElement('canvas');
            const img = new Image();
            
            // Set up retry mechanism
            let retryCount = 0;
            const maxRetries = 3;
            
            function attemptLoad() {
                loadCameraImage(
                    img,
                    canvas,
                    function(imageData) {
                        // Success - process the image data
                        console.log('Successfully loaded image:', {
                            width: canvas.width,
                            height: canvas.height
                        });
                        // Your image processing code here
                    },
                    function(error) {
                        console.error('Failed to load image:', error);
                        if (retryCount < maxRetries) {
                            retryCount++;
                            console.log(`Retrying (${retryCount}/${maxRetries})...`);
                            setTimeout(attemptLoad, 1000); // Wait 1 second before retry
                        } else {
                            console.error('Max retries reached, giving up');
                            // Handle permanent failure
                        }
                    }
                );
            }
            
            // Start the first attempt
            attemptLoad();
        }

        // Clamp ROI points to frame bounds
        function clampRoiPoints(points, maxWidth, maxHeight) {
            return points.map(([x, y]) => [
                Math.max(0, Math.min(x, maxWidth - 1)),
                Math.max(0, Math.min(y, maxHeight - 1))
            ]);
        }

        function updateResourceMonitor() {
            fetch('/api/resource_usage')
                .then(res => res.json())
                .then(data => {
                    // Update CPU
                    const cpuValue = data.cpu_percent !== undefined ? data.cpu_percent.toFixed(1) : '--';
                    document.getElementById('cpu-usage').textContent = cpuValue;
                    updateProgressBar('cpu-bar', cpuValue);

                    // Update RAM
                    const ramValue = data.ram_percent !== undefined ? data.ram_percent.toFixed(1) : '--';
                    document.getElementById('ram-usage').textContent = ramValue;
                    updateProgressBar('ram-bar', ramValue);

                    // Update Disk
                    const diskValue = data.disk_percent !== undefined ? data.disk_percent.toFixed(1) : '--';
                    document.getElementById('disk-usage').textContent = diskValue;
                    updateProgressBar('disk-bar', diskValue);

                    // Update GPU
                    const gpuElement = document.getElementById('gpu-usage');
                    const gpuValue = data.gpu_percent !== null && data.gpu_percent !== undefined 
                        ? data.gpu_percent.toFixed(1) 
                        : 'N/A';
                    gpuElement.textContent = gpuValue;
                    updateProgressBar('gpu-bar', gpuValue === 'N/A' ? 0 : gpuValue);

                    // Update card states based on values
                    updateCardStates();
                });
        }

        function updateProgressBar(barClass, value) {
            const bar = document.querySelector('.' + barClass);
            if (bar && !isNaN(value)) {
                bar.style.width = value + '%';
                
                // Add color classes based on value
                if (value > 90) {
                    bar.style.filter = 'brightness(1.2) saturate(1.2)';
                } else if (value > 70) {
                    bar.style.filter = 'brightness(1.1) saturate(1.1)';
                } else {
                    bar.style.filter = 'none';
                }
            }
        }

        function updateCardStates() {
            document.querySelectorAll('.resource-card').forEach(card => {
                const valueEl = card.querySelector('.resource-value span');
                const value = parseFloat(valueEl.textContent);
                
                if (!isNaN(value)) {
                    // Remove existing state classes
                    card.classList.remove('state-normal', 'state-warning', 'state-danger');
                    
                    // Add appropriate state class
                    if (value > 90) {
                        card.classList.add('state-danger');
                    } else if (value > 70) {
                        card.classList.add('state-warning');
                    } else {
                        card.classList.add('state-normal');
                    }
                }
            });
        }

        // Start monitoring
        setInterval(updateResourceMonitor, 2000);
        updateResourceMonitor();

        // Consolidated alert sound function
        function playAlertSound(cameraId = null) {
            const alertSound = document.getElementById('alert-sound');
            if (!alertSound) {
                console.error('Alert sound element not found');
                return;
            }

            // Check global alert sound setting
            const globalAlertEnabled = document.getElementById('alert-sound-toggle').checked;
            if (!globalAlertEnabled) {
                console.log('Global alert sound is disabled');
                return;
            }

            // If cameraId is provided, check camera-specific setting
            if (cameraId) {
                const cameraAlertEnabled = document.getElementById(`alert-sound-toggle-${cameraId}`)?.checked;
                if (!cameraAlertEnabled) {
                    console.log(`Alert sound is disabled for camera ${cameraId}`);
                    return;
                }
            }

            // Reset the audio to start
            alertSound.currentTime = 0;
            
            // Try to play the sound
            const playPromise = alertSound.play();
            
            if (playPromise !== undefined) {
                playPromise
                    .then(() => {
                        console.log(`Alert sound played successfully${cameraId ? ` for camera ${cameraId}` : ''}`);
                    })
                    .catch(err => {
                        console.error(`Error playing alert sound${cameraId ? ` for camera ${cameraId}` : ''}:`, err);
                        if (err.name === 'NotAllowedError') {
                            showToast('Please interact with the page first to enable alert sounds.', 'warning');
                        } else {
                            showToast('Error playing alert sound. Check browser audio settings.', 'warning');
                        }
                    });
            }
        }

        // Add event listeners for camera alert controls
        function setupCameraAlertControls() {
            // Save camera alert preferences to localStorage
            document.querySelectorAll('.camera-alert-toggle').forEach(toggle => {
                const cameraId = toggle.id.replace('alert-sound-toggle-', '');
                // Load saved preference
                const savedState = localStorage.getItem(`camera-${cameraId}-alert-enabled`);
                toggle.checked = savedState === null ? true : savedState === 'true';
                
                toggle.addEventListener('change', function(e) {
                    localStorage.setItem(`camera-${cameraId}-alert-enabled`, e.target.checked);
                });
            });
            
            // Test alert sound buttons
            document.querySelectorAll('.test-alert-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const cameraId = this.getAttribute('data-camera-id');
                    playAlertSound(cameraId);
                });
            });
        }

        // Update alert icon references
        const alertIcon = '/static/images/alert-icon.svg';

        // ... existing code ...

        // Update the alert badge HTML
        function updateAlertBadge(count) {
            const alertBadge = document.getElementById('alert-badge');
            if (alertBadge) {
                alertBadge.innerHTML = `
                    <img src="${alertIcon}" alt="Alert" class="alert-icon" style="width: 16px; height: 16px; margin-right: 4px;">
                    <span>${count}</span>
                `;
            }
        }

        // ... existing code ...
    </script>
    <!-- Add this right before the closing </body> tag -->
    <script>
        // Canvas loading management
        document.addEventListener('DOMContentLoaded', function() {
            // Handle ROI modal events
            const roiModal = document.getElementById('roiModal');
            if (roiModal) {
                roiModal.addEventListener('show.bs.modal', function() {
                    // Show loading indicator when modal opens
                    const loadingIndicator = document.getElementById('canvas-loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'block';
                    }
                });
                
                // Set up MutationObserver to watch for canvas changes
                const canvasContainer = document.querySelector('.canvas-container');
                if (canvasContainer) {
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                                // Check if the video feed has been loaded
                                const canvas = document.getElementById('roi-canvas');
                                if (canvas && canvas.width > 100 && canvas.height > 100) {
                                    // Hide loading indicator
                                    const loadingIndicator = document.getElementById('canvas-loading-indicator');
                                    if (loadingIndicator) {
                                        loadingIndicator.style.display = 'none';
                                    }
                                }
                            }
                        });
                    });
                    
                    observer.observe(canvasContainer, { 
                        childList: true, 
                        subtree: true, 
                        attributes: true,
                        attributeFilter: ['width', 'height', 'style']
                    });
                }
            }
        });
    </script>
    <script>
        // Add active class to nav links on click
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Update alert badge in sidebar
        function updateSidebarAlertBadge(count) {
            const badge = document.getElementById('sidebar-alert-badge');
            if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? 'inline-block' : 'none';
            }
        }

        // Toggle sidebar on mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('show');
        }
    </script>

    <!-- Add mobile toggle button -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="bi bi-list"></i>
    </button>

    <!-- Move this near the top of the body, after the sidebar -->
    <div class="alert-sound-control">
        <button id="toggleAlertSound" class="alert-sound-toggle" onclick="toggleAlertSound()">
            <span class="alert-sound-status active"></span>
            <i class="bi bi-volume-up"></i>
            <span>Alert Sound</span>
        </button>
    </div>

    <script>
        // Alert Sound Control
        let alertSoundEnabled = true;

        function toggleAlertSound() {
            const button = document.getElementById('toggleAlertSound');
            const status = button.querySelector('.alert-sound-status');
            const icon = button.querySelector('i');
            
            alertSoundEnabled = !alertSoundEnabled;
            
            if (alertSoundEnabled) {
                button.classList.remove('inactive');
                button.classList.add('active');
                status.classList.remove('inactive');
                status.classList.add('active');
                icon.classList.remove('bi-volume-mute');
                icon.classList.add('bi-volume-up');
                button.setAttribute('title', 'Alert Sound Enabled');
            } else {
                button.classList.remove('active');
                button.classList.add('inactive');
                status.classList.remove('active');
                status.classList.add('inactive');
                icon.classList.remove('bi-volume-up');
                icon.classList.add('bi-volume-mute');
                button.setAttribute('title', 'Alert Sound Disabled');
            }
        }

        // Unified playAlertSound function for global alert sound
        function playAlertSound() {
            if (!alertSoundEnabled) return;
            const alertSound = document.getElementById('alert-sound');
            if (alertSound) {
                alertSound.currentTime = 0; // Reset to start
                alertSound.play().catch(error => {
                    console.error('Error playing alert sound:', error);
                });
            }
        }
    </script>

    <script>
        // Add click handler for the System Resource Monitor link
        document.addEventListener('DOMContentLoaded', function() {
            const resourceMonitorLink = document.querySelector('a[href="#resource-monitor-section"]');
            if (resourceMonitorLink) {
                resourceMonitorLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = document.getElementById('resource-monitor-section');
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth' });
                    }
                    // Update active state
                    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                    this.classList.add('active');
                });
            }
        });
    </script>

    <script>
        // Navigation click handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Handle Cameras link
            const camerasLink = document.querySelector('a[href="#cameras-section"]');
            if (camerasLink) {
                camerasLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = document.getElementById('camera-section');
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth' });
                    }
                    // Update active state
                    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                    this.classList.add('active');
                });
            }

            // Handle Resource Monitor link
            const resourceMonitorLink = document.querySelector('a[href="#resource-monitor-section"]');
            if (resourceMonitorLink) {
                resourceMonitorLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = document.getElementById('resource-monitor-section');
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth' });
                    }
                    // Update active state
                    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                    this.classList.add('active');
                });
            }

            // Handle Alerts link
            const alertsLink = document.querySelector('a[href="#alerts-section"]');
            if (alertsLink) {
                alertsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = document.getElementById('alerts-section');
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth' });
                    }
                    // Update active state
                    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                    this.classList.add('active');
                });
            }

            // Handle Analytics link
            const analyticsLink = document.querySelector('a[href="#analytics-section"]');
            if (analyticsLink) {
                analyticsLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = document.getElementById('analytics-section');
                    if (section) {
                        section.scrollIntoView({ behavior: 'smooth' });
                    }
                    // Update active state
                    document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                    this.classList.add('active');
                });
            }
        });
    </script>

    
</body>
</html>
